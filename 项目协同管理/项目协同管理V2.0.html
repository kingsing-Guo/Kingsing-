<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®å»ºè®¾æƒ…å†µè¿›å±•çœ‹æ¿ - ç”Ÿäº§å°±ç»ªç‰ˆ</title>
    <!-- æ ¸å¿ƒåº“å¼•å…¥ -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/antd/dist/antd.min.js"></script>
    <script src="https://unpkg.com/@ant-design/icons/dist/index.umd.js"></script>
    <!-- å¼•å…¥ Excel å¤„ç†åº“ -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/antd/dist/reset.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch };
    </script>

    <style>
        body { background-color: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
        .ant-card { border-radius: 12px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stat-card-active { border: 2px solid #3b82f6 !important; background: #eff6ff !important; }
        .clickable-card { cursor: pointer; transition: all 0.2s; }
        .clickable-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .bid-quote { border-left: 4px solid #cbd5e1; background: #f8fafc; padding: 12px; border-radius: 0 8px 8px 0; }
        .strategy-highlight { border-left: 4px solid #3b82f6; background: #eff6ff; padding: 12px; border-radius: 0 8px 8px 0; }
        .interaction-thread { position: relative; padding: 12px; background: #fff; border: 1px solid #f1f5f9; border-radius: 12px; margin-bottom: 16px; }
        .login-page { min-height: 100vh; background: #f0f2f5 url('https://gw.alipayobjects.com/zos/rmsportal/TVirNRn97huYpToB.svg') no-repeat center; background-size: 100%; display: flex; align-items: center; justify-content: center; }
        .login-container-pc { display: flex; width: 1000px; height: 600px; background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .login-left { flex: 1; background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 60px; display: flex; flex-direction: column; justify-content: center; color: #fff; }
        .login-right { width: 450px; padding: 60px; background: #fff; display: flex; flex-direction: column; justify-content: center; }
        
        .subsystem-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 20px; 
            padding: 12px 16px; 
            background: #f1f5f9;
            border-radius: 8px; 
            cursor: pointer; 
            user-select: none; 
            transition: all 0.3s;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .subsystem-header:hover { background: #e2e8f0; }
        .subsystem-bar { width: 4px; height: 18px; background: #3b82f6; border-radius: 2px; }
        
        .dragging { opacity: 0.4; }
        .drag-over { border: 2px dashed #3b82f6 !important; }
        .subsystem-drag-over { background: #dbeafe !important; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .info-display-label { color: #64748b; font-weight: 500; font-size: 13px; }
        .info-display-value { color: #1e293b; font-weight: 600; font-size: 14px; }
        .section-tag { background: #eff6ff; color: #3b82f6; border: none; font-weight: bold; margin-bottom: 12px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        const { 
            Layout, Card, Progress, Tag, Row, Col, Badge, Steps, Button, List, 
            Avatar, Input, ConfigProvider, Space, Divider, Typography, Modal, 
            Form, InputNumber, Select, message, Timeline, Collapse, Upload, 
            DatePicker, Radio, Spin, Result, Empty, Popconfirm, Checkbox, Tooltip, Table, Descriptions
        } = window.antd;
        
        const { 
            SearchOutlined, FileTextOutlined, MessageOutlined, ClockCircleOutlined, 
            LeftOutlined, PlusOutlined, ThunderboltOutlined, TeamOutlined, SendOutlined, 
            EditOutlined, ToolOutlined, DeleteOutlined, PaperClipOutlined, DownloadOutlined, 
            ImportOutlined, FolderOpenOutlined, SafetyOutlined, RedoOutlined, InboxOutlined, 
            CheckCircleOutlined, UserOutlined, ExportOutlined, LockOutlined, MobileOutlined, 
            VerifiedOutlined, LoginOutlined, CloudUploadOutlined, UploadOutlined, 
            AppstoreOutlined, DownOutlined, RightOutlined, MenuUnfoldOutlined, MenuFoldOutlined,
            ClearOutlined, DragOutlined, TableOutlined, AppstoreAddOutlined, AlertOutlined, FilterOutlined,
            BellOutlined, InfoCircleOutlined, AuditOutlined, SettingOutlined
        } = window.icons;

        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'credit-board-cloud-v3';
        const initialToken = window.__initial_auth_token || '';

        const STRATEGY_OPTIONS = [
            { label: 'ç°æœ‰äº§å“æ”¹é€ ', value: 'customization', color: 'purple' },
            { label: 'é‡æ–°å®šåˆ¶å¼€å‘', value: 'development', color: 'blue' },
            { label: 'é«˜ä¿çœŸDEMO', value: 'demo', color: 'orange' },
            { label: 'æ–‡å­—è¯´æ˜å“åº”', value: 'text_description', color: 'green' }
        ];
        const DOC_TYPES = ['ä¼šè®®çºªè¦', 'éœ€æ±‚æ–‡æ¡£', 'è®¾è®¡æ–‡æ¡£', 'æ“ä½œæ‰‹å†Œ', 'æµ‹è¯•æŠ¥å‘Š'];
        const ALLOWED_EXTS = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.png', '.jpg', '.jpeg', '.zip', '.rar'];

        // --- å­ç»„ä»¶ ---
        const LoginView = ({ onLogin, projectInfo }) => {
            const [role, setRole] = useState('team');
            const [loading, setLoading] = useState(false);
            const handleSubmit = () => { setLoading(true); setTimeout(() => { setLoading(false); onLogin(role); }, 600); };
            return (
                <div className="login-page">
                    <div className="login-container-pc fade-in">
                        <div className="login-left">
                            <div className="mb-12">
                                <div className="bg-white/20 w-16 h-16 rounded-2xl flex items-center justify-center mb-6"><SafetyOutlined className="text-white text-3xl" /></div>
                                <h1 className="text-3xl font-bold text-white mb-2">é¡¹ç›®å»ºè®¾æƒ…å†µè¿›å±•çœ‹æ¿</h1>
                                <h2 className="text-xl text-white/80 font-medium italic uppercase tracking-wider">{projectInfo?.name || 'é¡¹ç›®å°šæœªå‘½å'}</h2>
                            </div>
                            <div className="space-y-6 text-blue-50">
                                <div className="flex items-center gap-4"><CheckCircleOutlined /><span>å¤šæ–¹å®æ—¶å¯¹é½ éœ€æ±‚é—­ç¯è¿½è¸ª</span></div>
                                <div className="flex items-center gap-4"><CheckCircleOutlined /><span>ç ”å‘åŠ¨æ€é€æ˜ æ ‡ä¹¦æŒ‡æ ‡è¦†ç›–</span></div>
                            </div>
                            <div className="mt-auto pt-10 border-t border-white/10 text-white/50 text-xs">Â© 2026 {projectInfo?.clientUnit || 'é¡¹ç›®ç®¡ç†å•ä½'}</div>
                        </div>
                        <div className="login-right">
                            <div className="mb-10 text-center"><h3 className="text-2xl font-bold text-slate-800 m-0">å®‰å…¨ç™»å½•å…¥å£</h3><div className="w-12 h-1 bg-blue-600 mx-auto mt-3 rounded-full"></div></div>
                            <Form layout="vertical" onFinish={handleSubmit}>
                                <Form.Item label="ç™»å½•èº«ä»½" className="mb-6">
                                    <Radio.Group value={role} onChange={e => setRole(e.target.value)} buttonStyle="solid" className="w-full flex">
                                        <Radio.Button value="partyA" className="flex-1 text-center">ç”²æ–¹è´Ÿè´£äºº</Radio.Button>
                                        <Radio.Button value="team" className="flex-1 text-center">é¡¹ç›®ç»„ä¸“å®¶</Radio.Button>
                                    </Radio.Group>
                                </Form.Item>
                                <Form.Item name="username" initialValue="admin"><Input prefix={<UserOutlined />} placeholder="è¯·è¾“å…¥è´¦å·" size="large" /></Form.Item>
                                <Form.Item name="password" initialValue="123456"><Input.Password prefix={<LockOutlined />} placeholder="è¯·è¾“å…¥å¯†ç " size="large" /></Form.Item>
                                <Button type="primary" htmlType="submit" size="large" block loading={loading} className="h-12 bg-blue-600 font-bold">åŒæ­¥è¿›å…¥çœ‹æ¿</Button>
                            </Form>
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ modules, stats, filterMode, onFilterChange, onSelect, onAdd, onImport, onExport, onDelete, onDeleteAll, onReorderModules, onReorderSubsystems, searchText, onSearchChange, userRole, onLogout, onOpenProjectInfo, onOpenWeeklyReports, projectInfo }) => {
            const [displayMode, setDisplayMode] = useState('card');
            
            const hasNewFeedback = (item) => {
                if (!item.feedbackGroups) return false;
                return userRole === 'team' 
                    ? item.feedbackGroups.some(g => (g.replies || []).length === 0)
                    : item.feedbackGroups.some(g => (g.replies || []).length > 0);
            };

            // è¡¥å›è¡¨æ ¼åˆ—å®šä¹‰
            const tableColumns = [
                { 
                    title: 'æ¨¡å—åç§°', 
                    dataIndex: 'name', 
                    key: 'name', 
                    fixed: 'left', 
                    width: 250, 
                    render: (text, record) => (
                        <Badge dot={hasNewFeedback(record)} offset={[5, 0]}>
                            <Button type="link" onClick={() => onSelect(record.id)} className="p-0 font-bold text-slate-800 hover:text-blue-600 text-left">{text}</Button>
                        </Badge>
                    )
                },
                { title: 'æ‰€å±å­ç³»ç»Ÿ', dataIndex: 'subsystem', key: 'subsystem', width: 180, render: (text) => <Tag className="border-none bg-slate-100">{text}</Tag> },
                { title: 'å“åº”ç­–ç•¥', dataIndex: 'strategyType', key: 'strategyType', width: 150, render: (val) => { const opt = STRATEGY_OPTIONS.find(o => o.value === val); return opt ? <Tag color={opt.color} className="border-none">{opt.label}</Tag> : '-'; } },
                { title: 'è¿›åº¦', dataIndex: 'progress', key: 'progress', width: 180, sorter: (a, b) => (a.progress || 0) - (b.progress || 0), render: (val) => <Progress percent={val || 0} size="small" strokeColor="#3b82f6" /> },
                { title: 'é¢„è®¡å®Œæˆæ—¶é—´', dataIndex: 'deadline', key: 'deadline', width: 150, sorter: (a, b) => dayjs(a.deadline).unix() - dayjs(b.deadline).unix(), render: (text) => <span className="font-mono text-slate-500">{text || '-'}</span> },
                { 
                    title: 'çŠ¶æ€', 
                    key: 'delayed', 
                    width: 120, 
                    render: (_, record) => { 
                        const isDelayed = dayjs().isAfter(dayjs(record.deadline)) && (record.progress || 0) < 100; 
                        return isDelayed ? <Tag color="error" icon={<AlertOutlined />} className="font-bold">å·²å»¶è¯¯</Tag> : <Tag color="success" className="font-bold">æ­£å¸¸</Tag>; 
                    } 
                },
                { 
                    title: 'æ“ä½œ', 
                    key: 'action', 
                    fixed: 'right', 
                    width: 100, 
                    render: (_, record) => (
                        <Space>
                            <Tooltip title="è¯¦æƒ…"><Button type="text" size="small" icon={<SearchOutlined />} onClick={() => onSelect(record.id)} /></Tooltip>
                            {userRole === 'team' && (
                                <Popconfirm title="ç¡®å®šåˆ é™¤ï¼Ÿ" onConfirm={() => onDelete(record.id)} okButtonProps={{ danger: true }}>
                                    <Button type="text" danger size="small" icon={<DeleteOutlined />} />
                                </Popconfirm>
                            )}
                        </Space>
                    ) 
                }
            ];

            const finalFilteredModules = useMemo(() => {
                let list = [...modules].sort((a, b) => (a.order || 0) - (b.order || 0));
                const search = searchText.toLowerCase();
                list = list.filter(m => (m.name || '').toLowerCase().includes(search) || (m.chapter || '').toLowerCase().includes(search));
                if (filterMode === 'completed') list = list.filter(m => (m.progress || 0) === 100);
                else if (filterMode === 'pendingIssues') list = list.filter(m => m.issues?.some(i => i.status === 'pending'));
                else if (filterMode === 'pendingFeedback') list = list.filter(m => m.feedbackGroups?.some(g => (g.replies || []).length === 0));
                else if (filterMode === 'delayed') list = list.filter(m => dayjs().isAfter(dayjs(m.deadline)) && (m.progress || 0) < 100);
                else if (STRATEGY_OPTIONS.map(o => o.value).includes(filterMode)) list = list.filter(m => (m.strategyType || 'development') === filterMode);
                return list;
            }, [modules, searchText, filterMode]);

            const groupedModules = useMemo(() => {
                const groups = {};
                finalFilteredModules.forEach(item => {
                    const ss = item.subsystem || 'åŸºç¡€æ”¯æ’‘å­ç³»ç»Ÿ';
                    if (!groups[ss]) groups[ss] = [];
                    groups[ss].push(item);
                });
                return groups;
            }, [finalFilteredModules]);

            const subsystemNames = useMemo(() => Object.keys(groupedModules), [groupedModules]);
            const [collapsedKeys, setCollapsedKeys] = useState([]);
            const toggleCollapse = (name) => setCollapsedKeys(prev => prev.includes(name) ? prev.filter(k => k !== name) : [...prev, name]);

            const [draggedModule, setDraggedModule] = useState(null);
            const [dragOverSubsystem, setDragOverSubsystem] = useState(null);
            const [dragOverModuleId, setDragOverModuleId] = useState(null);

            const handleModuleDragStart = (e, item) => { if(userRole !== 'team') return e.preventDefault(); setDraggedModule(item); e.dataTransfer.setData("type", "module"); };
            const handleModuleDrop = (e, targetItem) => { e.preventDefault(); e.stopPropagation(); if(draggedModule && draggedModule.id !== targetItem.id) onReorderModules(draggedModule.id, targetItem.id, targetItem.subsystem); setDraggedModule(null); setDragOverModuleId(null); };
            const handleSubsystemDragStart = (e, ssName) => { if(userRole !== 'team') return e.preventDefault(); setDraggedSubsystem(ssName); e.dataTransfer.setData("type", "subsystem"); e.dataTransfer.setData("ssName", ssName); };
            const handleSubsystemDrop = (e, targetSS) => { e.preventDefault(); const type = e.dataTransfer.getData("type"); if(type === "subsystem") { const from = e.dataTransfer.getData("ssName"); if(from !== targetSS) onReorderSubsystems(from, targetSS); } else if(type === "module" && draggedModule) onReorderModules(draggedModule.id, null, targetSS); setDragOverSubsystem(null); };

            return (
                <div className="max-w-7xl mx-auto p-6 fade-in">
                    <div className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg text-white font-bold text-xl flex items-center justify-center w-10 h-10 shadow-lg shadow-blue-200"><ThunderboltOutlined /></div>
                            <div className="flex flex-col">
                                <h1 className="text-xl font-bold text-slate-800 m-0 leading-tight">é¡¹ç›®å»ºè®¾æƒ…å†µè¿›å±•çœ‹æ¿</h1>
                                <div className="text-[11px] text-slate-400 mt-1 font-medium tracking-wide uppercase italic">{projectInfo?.name || 'é¡¹ç›®å°šæœªå‘½å'}</div>
                            </div>
                            <Space className="ml-4">
                                <Button icon={<InfoCircleOutlined />} onClick={onOpenProjectInfo} className="rounded-full border-blue-200 text-blue-600 hover:bg-blue-50 font-medium">é¡¹ç›®åŸºæœ¬æƒ…å†µ</Button>
                                <Button icon={<AuditOutlined />} onClick={onOpenWeeklyReports} className="rounded-full border-indigo-200 text-indigo-600 hover:bg-indigo-50 font-medium">é¡¹ç›®å‘¨æŠ¥</Button>
                            </Space>
                        </div>
                        <div className="flex gap-4 items-center">
                            <Input prefix={<SearchOutlined />} placeholder="æœç´¢æ¨¡å—..." className="w-64 rounded-lg bg-slate-100 border-none h-10" value={searchText} onChange={e => onSearchChange(e.target.value)} />
                            <div className="flex items-center gap-3 px-4 py-1.5 bg-white rounded-full border border-slate-200 shadow-sm ml-2">
                                <Avatar size="small" icon={<UserOutlined />} className="bg-blue-600" />
                                <div className="text-left leading-tight"><div className="text-xs font-bold text-slate-700">{userRole === 'partyA' ? 'ç‹å»ºå›½ (ç”²æ–¹è´Ÿè´£äºº)' : 'æå¿—å¼º (é¡¹ç›®ç»„ä¸“å®¶)'}</div><div className="text-[10px] text-green-500 font-medium">æ•°æ®å®æ—¶åŒæ­¥ä¸­</div></div>
                                <Divider type="vertical" />
                                <Button type="link" size="small" danger onClick={onLogout} className="p-0 text-[10px]">é€€å‡º</Button>
                            </div>
                        </div>
                    </div>

                    <Row gutter={12} className="mb-8">
                        <Col span={4}><Card size="small" className={`h-36 flex flex-col justify-center clickable-card ${filterMode === 'all' ? 'stat-card-active' : ''}`} onClick={() => onFilterChange('all')}><div className="text-slate-500 text-xs mb-3 font-bold">æ€»ä½“è¿›åº¦</div><div className="text-center"><span className="text-blue-600 text-2xl font-bold">{stats.totalProgress}%</span></div><Progress percent={stats.totalProgress} showInfo={false} strokeWidth={10} /><div className="text-slate-400 text-[10px] mt-3">å…± <span className="text-slate-800 font-bold">{stats.total}</span> æ¨¡å—</div></Card></Col>
                        
                        <Col span={6}>
                            <Card size="small" className="h-36">
                                <div className="text-slate-500 text-xs mb-3 font-bold">å“åº”ç­–ç•¥</div>
                                <div className="space-y-1.5 overflow-y-auto max-h-[90px] custom-scroll">
                                    {STRATEGY_OPTIONS.map(opt => {
                                        const count = stats.strategyCounts[opt.value] || 0;
                                        const percent = stats.total > 0 ? ((count / stats.total) * 100).toFixed(1) : "0.0";
                                        return (
                                            <div key={opt.value} className={`flex justify-between px-1 py-0.5 rounded cursor-pointer hover:bg-slate-50 ${filterMode === opt.value ? 'bg-blue-50' : ''}`} onClick={() => onFilterChange(opt.value)}>
                                                <span className="text-[10px] text-slate-500">{opt.label}</span>
                                                <span className={`text-[11px] font-bold text-${opt.color}-600`}>{count} <span className="text-[9px] font-normal text-slate-400 ml-1">({percent}%)</span></span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </Card>
                        </Col>
                        <Col span={4}>
                            <Card size="small" className={`h-36 clickable-card ${filterMode === 'completed' ? 'stat-card-active' : ''}`} onClick={() => onFilterChange('completed')}>
                                <div className="text-slate-500 text-sm mb-1 font-bold">ç ”å‘è¿›å±•</div>
                                <div className="text-2xl font-bold text-slate-800 mb-1">{stats.completed} <span className="text-xs font-normal text-slate-400">/ {stats.total}</span></div>
                                <div className="text-blue-600 text-[10px] font-bold mb-2">{stats.completedSubsystems} <span className="font-normal text-slate-400">/ {stats.subsystemCount} å­ç³»ç»Ÿå®Œæˆ</span></div>
                                <div className="inline-flex items-center px-3 py-1 bg-green-50 text-green-600 rounded-full border border-green-100 text-[9px] font-bold"><SafetyOutlined className="mr-1" /> å·²å®Œæˆæ˜ç»†</div>
                            </Card>
                        </Col>
                        <Col span={4}><Card size="small" className={`h-36 clickable-card ${filterMode === 'delayed' ? 'stat-card-active' : ''}`} onClick={() => onFilterChange('delayed')}><div className="text-slate-500 text-xs mb-1 font-bold">è¿›åº¦å»¶è¯¯</div><div className="text-4xl font-bold text-red-500 mb-2">{stats.delayedCount} <span className="text-xs font-normal text-slate-400">é¡¹</span></div><div className="inline-flex items-center px-2 py-0.5 bg-red-50 text-red-600 rounded-full border border-red-100 text-[9px] font-bold"><AlertOutlined className="mr-1" /> é£é™©é¢„è­¦</div></Card></Col>
                        <Col span={3}><Card size="small" className={`h-36 clickable-card ${filterMode === 'pendingIssues' ? 'stat-card-active' : ''}`} onClick={() => onFilterChange('pendingIssues')}><div className="text-slate-500 text-xs mb-1 font-bold">åè°ƒäº‹é¡¹</div><div className="text-4xl font-bold text-slate-800 mb-2">{stats.pendingIssues} <span className="text-xs font-normal text-slate-400">é¡¹</span></div><div className="inline-flex items-center px-2 py-0.5 bg-orange-50 text-orange-600 rounded-full border border-orange-100 text-[9px] font-bold"><ClockCircleOutlined className="mr-1" /> éœ€é…åˆ</div></Card></Col>
                        <Col span={3}>
                            <Card size="small" className={`h-36 clickable-card ${filterMode === 'pendingFeedback' ? 'stat-card-active' : ''}`} onClick={() => onFilterChange('pendingFeedback')}>
                                <div className="text-slate-500 text-xs mb-1 font-bold">ç”¨æˆ·åé¦ˆ</div>
                                <div className="text-4xl font-bold text-slate-800 mb-2">{stats.totalFeedback} <span className="text-xs font-normal text-slate-400">æ¡</span></div>
                                <div className="inline-flex items-center px-2 py-0.5 bg-blue-50 text-blue-600 rounded-full border border-blue-100 text-[9px] font-bold"><MessageOutlined className="mr-1" /> å¾…å¤„ç†</div>
                            </Card>
                        </Col>
                    </Row>

                    {filterMode !== 'all' && (
                        <div className="mb-6 flex justify-between items-center bg-blue-50 p-4 rounded-xl border border-blue-100 transition-all fade-in shadow-sm">
                            <span className="text-blue-700 text-sm font-bold flex items-center gap-2"><ThunderboltOutlined /> å½“å‰è¿‡æ»¤ï¼š{
                                STRATEGY_OPTIONS.find(o => o.value === filterMode)?.label || 
                                (filterMode === 'completed' ? 'å·²å®Œæˆæ¨¡å—' : filterMode === 'pendingIssues' ? 'å¾…å¤„ç†åè°ƒäº‹é¡¹' : filterMode === 'delayed' ? 'å·²å»¶è¯¯æ¨¡å—' : 'å¾…å›å¤åé¦ˆè®°å½•')
                            }</span>
                            <Button type="primary" size="small" icon={<RedoOutlined />} onClick={() => onFilterChange('all')} className="bg-blue-600 border-none font-bold">é‡ç½®</Button>
                        </div>
                    )}

                    <div className="flex justify-between items-center gap-3 mb-4 p-3 bg-white shadow-sm rounded-xl">
                        <Space size="large">
                            <Radio.Group value={displayMode} onChange={e => setDisplayMode(e.target.value)} buttonStyle="solid">
                                <Radio.Button value="card">å¡ç‰‡è§†å›¾</Radio.Button>
                                <Radio.Button value="table">è¡¨æ ¼è§†å›¾</Radio.Button>
                            </Radio.Group>
                            {displayMode === 'card' && (
                                <Space>
                                    <Button size="small" icon={<MenuFoldOutlined />} onClick={() => setCollapsedKeys(subsystemNames)} className="text-xs">å…¨éƒ¨æ”¶èµ·</Button>
                                    <Button size="small" icon={<MenuUnfoldOutlined />} onClick={() => setCollapsedKeys([])} className="text-xs">å…¨éƒ¨å±•å¼€</Button>
                                </Space>
                            )}
                        </Space>
                        <Space>
                            <Button size="small" icon={<ExportOutlined />} onClick={onExport} className="text-xs">å¯¼å‡ºæ¨¡å—</Button>
                            {userRole === 'team' && (
                                <>
                                    <Divider type="vertical" />
                                    <Button size="small" icon={<ImportOutlined />} onClick={onImport} className="text-xs">æ‰¹é‡å¯¼å…¥</Button>
                                    <Popconfirm title="ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ¨¡å—æ•°æ®ï¼Ÿ" onConfirm={onDeleteAll} okButtonProps={{ danger: true }}>
                                        <Button size="small" icon={<ClearOutlined />} danger className="text-xs">å…¨éƒ¨åˆ é™¤</Button>
                                    </Popconfirm>
                                    <Button size="small" type="primary" icon={<PlusOutlined />} onClick={onAdd} className="text-xs font-bold bg-slate-900 border-none">æ–°å¢æ¨¡å—</Button>
                                </>
                            )}
                        </Space>
                    </div>

                    {displayMode === 'table' ? (
                        <div className="bg-white rounded-xl shadow-sm border border-slate-50 overflow-hidden fade-in">
                            <Table columns={tableColumns} dataSource={finalFilteredModules} rowKey="id" pagination={{ pageSize: 15, hideOnSinglePage: true }} scroll={{ x: 1100 }} size="middle" />
                        </div>
                    ) : (
                        <div className="space-y-8 pb-10">
                            {subsystemNames.map((ssName) => {
                                const subModules = groupedModules[ssName];
                                const isCollapsed = collapsedKeys.includes(ssName);
                                return (
                                    <div key={ssName} onDragOver={(e) => { e.preventDefault(); setDragOverSubsystem(ssName); }} onDragLeave={() => setDragOverSubsystem(null)} onDrop={(e) => handleSubsystemDrop(e, ssName)} className={`fade-in p-2 rounded-xl transition-all ${dragOverSubsystem === ssName ? 'subsystem-drag-over' : ''}`}>
                                        <div className="subsystem-header shadow-sm group" draggable={userRole === 'team'} onDragStart={(e) => handleSubsystemDragStart(e, ssName)} onClick={() => toggleCollapse(ssName)}>
                                            <div className="subsystem-bar"></div>
                                            {userRole === 'team' && <DragOutlined className="text-slate-300 opacity-0 group-hover:opacity-100 transition-all mr-1" />}
                                            <span className="text-lg font-bold text-slate-800 flex items-center gap-2"><AppstoreOutlined className="text-blue-500" />{ssName}</span>
                                            <Tag className="bg-slate-200 border-none text-slate-500 text-[10px]">{subModules.length} æ¨¡å—</Tag>
                                            <div className="ml-auto text-slate-400">{isCollapsed ? <DownOutlined /> : <DownOutlined className="rotate-180 transition-all" />}</div>
                                        </div>
                                        {!isCollapsed && (
                                            <div className="space-y-6 fade-in">
                                                {subModules.map(item => (
                                                    <div key={item.id} draggable={userRole === 'team'} onDragStart={(e) => handleModuleDragStart(e, item)} onDragOver={(e) => { e.preventDefault(); setDragOverModuleId(item.id); }} onDragLeave={() => setDragOverModuleId(null)} onDrop={(e) => handleModuleDrop(e, item)} className={`${dragOverModuleId === item.id ? 'drag-over' : ''} rounded-xl transition-all`}>
                                                        <Card hoverable className="border border-blue-50 relative" onClick={() => onSelect(item.id)} extra={userRole === 'team' && (
                                                            <Space><DragOutlined className="text-slate-300 mr-2" /><Popconfirm title="ç¡®å®šåˆ é™¤å—ï¼Ÿ" onConfirm={(e) => { e.stopPropagation(); onDelete(item.id); }} onCancel={(e) => e.stopPropagation()} okButtonProps={{ danger: true }}><Button type="text" danger icon={<DeleteOutlined />} onClick={(e) => e.stopPropagation()} className="opacity-20 hover:opacity-100" /></Popconfirm></Space>
                                                        )}>
                                                            <div className="flex justify-between items-start mb-2">
                                                                <div className="flex items-center gap-3">
                                                                    <Badge dot={hasNewFeedback(item)} offset={[5, 0]}><span className="text-xl font-bold text-slate-800">{item.name}</span></Badge>
                                                                    <Tag color="blue">{item.status}</Tag>
                                                                    {dayjs().isAfter(dayjs(item.deadline)) && (item.progress || 0) < 100 && (<Tag color="error" className="font-bold">å·²å»¶è¯¯</Tag>)}
                                                                    {item.strategyType && <Tag color={STRATEGY_OPTIONS.find(o => o.value === item.strategyType)?.color}>{STRATEGY_OPTIONS.find(o => o.value === item.strategyType)?.label}</Tag>}
                                                                    {item.progress === 100 && item.link && (<Button type="link" size="small" icon={<ExportOutlined />} onClick={(e) => { e.stopPropagation(); window.open(item.link, '_blank'); }} className="p-0 font-bold flex items-center">è®¿é—®ç³»ç»Ÿ</Button>)}
                                                                </div>
                                                                <div className="text-slate-800 font-bold text-sm flex items-center gap-1"><ClockCircleOutlined /> {item.deadline}</div>
                                                            </div>
                                                            <div className="text-slate-400 text-sm mb-6">{item.chapter}</div>
                                                            <div className="mb-4">
                                                                <div className="flex justify-between text-sm mb-2 font-medium"><span>è¿›åº¦æ¦‚è§ˆ</span><span>{item.progress}%</span></div>
                                                                <Progress percent={item.progress} showInfo={false} strokeWidth={12} strokeColor="#3b82f6" />
                                                            </div>
                                                            <div className="flex justify-between items-center pt-4 border-t">
                                                                <Space split={<Divider type="vertical" />}>
                                                                    <Badge count={item.issues?.filter(i => i.status === 'pending').length} offset={[5, -2]}><Tag color="error" className="rounded-lg px-3 py-1 font-bold text-xs">å¾…åè°ƒ</Tag></Badge>
                                                                    <Badge count={(item.feedbackGroups || []).filter(g => (g.replies || []).length === 0).length} offset={[5, -2]}><Tag color="processing" className="rounded-lg px-3 py-1 font-bold text-xs">åé¦ˆå»ºè®®</Tag></Badge>
                                                                </Space>
                                                                <span className="text-slate-500 text-sm flex items-center gap-2"><FileTextOutlined /> ç›¸å…³æ–‡æ¡£ ({item.docs?.length || 0})</span>
                                                            </div>
                                                        </Card>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const DetailView = ({ current, onBack, onEdit, onToggleIssue, onAddIssue, onOpenDocModal, onDeleteDoc, onAddHistory, userRole, feedbackProps, targetAnchor }) => {
            if (!current) return <div className="p-10"><Empty description="æœªæ‰¾åˆ°æ¨¡å—" /></div>;
            const { interactionText, setInteractionText, onSubmitInteraction } = feedbackProps;
            useEffect(() => { if (targetAnchor) { const el = document.getElementById(targetAnchor); if (el) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'start' }), 150); } }, [targetAnchor]);

            const combinedHistory = useMemo(() => {
                const list = [];
                (current.history || []).forEach(h => list.push({ ...h, color: 'blue', tag: 'è¿›å±•' }));
                return list.sort((a, b) => dayjs(b.time, "YYYY/M/D HH:mm").unix() - dayjs(a.time, "YYYY/M/D HH:mm").unix());
            }, [current]);

            const handleDownloadDoc = (docData) => {
                if (!docData.url) return message.warning('æ— æ³•ä¸‹è½½');
                const link = document.createElement('a'); link.href = docData.url; link.download = docData.name; link.click();
            };

            const sectionTitle = (icon, text, color) => (<div className="flex items-center gap-2 text-base font-bold">{React.cloneElement(icon, { className: color })}<span>{text}</span></div>);

            return (
                <div className="max-w-7xl mx-auto p-6 fade-in">
                    <div className="mb-6 flex justify-between"><Button icon={<LeftOutlined />} onClick={onBack} className="font-bold rounded-lg h-10 px-6">è¿”å›çœ‹æ¿</Button>{userRole === 'team' && <Button icon={<EditOutlined />} onClick={onEdit} type="primary" className="font-bold rounded-lg h-10">æ›´æ–°ä¿¡æ¯</Button>}</div>
                    <div className="flex gap-6">
                        <div className="flex-1 space-y-6">
                            <Card className="shadow-sm">
                                <div className="flex flex-col gap-4">
                                    <div className="flex flex-col md:flex-row md:items-start justify-between gap-4">
                                        <h2 className="text-4xl font-extrabold text-slate-800 break-all flex-1 m-0 leading-tight">{current.name}</h2>
                                        <Space wrap className="shrink-0 pt-1">
                                            <Tag color="blue" className="m-0 font-bold px-3 py-0.5">{current.status}</Tag>
                                            {dayjs().isAfter(dayjs(current.deadline)) && (current.progress || 0) < 100 && (<Tag color="error" className="m-0 font-bold px-3 py-0.5">å·²å»¶è¯¯</Tag>)}
                                            <Tag className="m-0 bg-slate-100 border-slate-200">æ‰€å±å­ç³»ç»Ÿï¼š{current.subsystem}</Tag>
                                        </Space>
                                    </div>
                                    <Divider className="my-2" />
                                    <div className="flex flex-wrap items-center gap-y-2 gap-x-8 text-slate-500 text-sm">
                                        <div className="flex items-center gap-2"><ClockCircleOutlined /> è®¡åˆ’æˆªæ­¢: <span className="text-slate-800 font-bold">{current.deadline || 'æœªè®¾ç½®'}</span></div>
                                        <div className="flex items-center gap-2"><ToolOutlined /> å“åº”ç­–ç•¥: <span className="text-slate-800 font-bold">{STRATEGY_OPTIONS.find(o => o.value === current.strategyType)?.label}</span></div>
                                        {current.strategyType === 'customization' && current.modifiedModules && (<div className="flex items-center gap-2 text-blue-600 font-medium"><EditOutlined /> æ¶‰åŠæ”¹é€ : <span>{current.modifiedModules}</span></div>)}
                                    </div>
                                </div>
                            </Card>
                            <Card title={sectionTitle(<ThunderboltOutlined />, "å®æ–½ç­–ç•¥ä¸è¿›åº¦è¯¦æƒ…", "text-blue-500")} extra={<span className="text-3xl font-bold text-slate-800">{current.progress}%</span>}>
                                <div className="mb-8"><Progress percent={current.progress} showInfo={false} strokeWidth={12} strokeColor="#3b82f6" /></div>
                                <Row gutter={24}>
                                    <Col span={12}><div className="text-xs text-slate-400 mb-2 font-bold uppercase tracking-widest">æ ‡ä¹¦åŸæ–‡æŒ‡æ ‡</div><div className="bid-quote text-sm h-48 overflow-auto custom-scroll italic leading-relaxed">{current.tender || 'æ— æŒ‡æ ‡å†…å®¹'}</div></Col>
                                    <Col span={12}><div className="text-xs text-slate-400 mb-2 font-bold uppercase tracking-widest">å…·ä½“å®æ–½ç­–ç•¥</div><div className="strategy-highlight text-sm h-48 overflow-auto custom-scroll leading-relaxed">{current.strategy || 'æ— å®æ–½ç­–ç•¥å†…å®¹'}</div></Col>
                                </Row>
                            </Card>
                            <Card title={sectionTitle(<ClockCircleOutlined />, "ç ”å‘åŠ¨æ€å†å²è¿½è¸ª", "text-indigo-500")}>
                                {userRole === 'team' && <div className="mb-6"><Input.Search size="large" placeholder="æ–°å¢è¿›å±•è®°å½•..." enterButton="æ·»åŠ è¿›å±•" onSearch={onAddHistory} /></div>}
                                <div className="max-h-[500px] overflow-auto custom-scroll pr-2">
                                    <Timeline items={combinedHistory.map((h, i) => ({ 
                                        color: h.color, 
                                        children: (
                                            <div>
                                                <div className="text-sm font-medium">{h.tag && <Tag color={h.color} className="text-[10px] scale-90 -translate-x-1">{h.tag}</Tag>} {h.content}</div>
                                                <div className="text-[10px] text-slate-400 mt-1 italic">ğŸ“… {h.time}</div>
                                            </div>
                                        )
                                    })) } />
                                </div>
                            </Card>
                        </div>
                        <div className="w-[420px] space-y-6">
                            <Card id="docs-anchor" title={sectionTitle(<FolderOpenOutlined />, "ç›¸å…³æ–‡æ¡£åº“", "text-green-500")} extra={userRole === 'team' && <Button type="link" size="small" icon={<PlusOutlined />} onClick={onOpenDocModal}>å½’æ¡£</Button>}>
                                <div className="max-h-[300px] overflow-auto custom-scroll">
                                    {current.docs?.length ? (
                                        <List size="small" dataSource={current.docs} renderItem={(doc, i) => (
                                            <List.Item extra={
                                                <Space>
                                                    <Tooltip title="ç‚¹å‡»ä¸‹è½½æ­¤æ–‡ä»¶"><Button type="text" size="small" icon={<DownloadOutlined className="text-blue-500" />} onClick={() => handleDownloadDoc(doc)} /></Tooltip>
                                                    {userRole === 'team' && <Button type="text" size="small" danger icon={<DeleteOutlined />} onClick={() => onDeleteDoc(i)} />}
                                                </Space>
                                            }>
                                                <List.Item.Meta title={<span className="text-xs font-bold text-slate-700">{doc.name}</span>} description={
                                                    <div className="flex flex-col">
                                                        <div className="flex gap-2">
                                                            <Tag className="text-[10px] m-0">{doc.type}</Tag>
                                                            <span className="text-[10px] text-slate-400 font-sans">ğŸ“… {doc.date}</span>
                                                        </div>
                                                        <span className="text-[10px] text-slate-300">{doc.size}</span>
                                                    </div>
                                                } />
                                            </List.Item>
                                        )} />
                                    ) : <Empty image={Empty.PRESENTED_IMAGE_SIMPLE} />}
                                </div>
                            </Card>
                            <Card id="feedback-anchor" title={sectionTitle(<MessageOutlined />, "ç”¨æˆ·åé¦ˆä¸æ„è§", "text-blue-500")}>
                                <div className="mb-6"><Input.Search size="large" placeholder={userRole === 'partyA' ? "æäº¤å»ºè®®..." : "é’ˆå¯¹æœ€æ–°åé¦ˆè¿›è¡Œå›å¤..."} enterButton={userRole === 'partyA' ? 'æäº¤' : 'å›å¤'} onSearch={onSubmitInteraction} disabled={userRole === 'team' && !current.feedbackGroups?.length} /></div>
                                <div className="max-h-[400px] overflow-auto custom-scroll pr-2">
                                    <Timeline items={(current.feedbackGroups || []).map(g => ({ color: 'green', children: (<div className="interaction-thread"><div><div className="flex justify-between items-center mb-1"><Tag color="green" className="text-[10px]">ç”²æ–¹åé¦ˆ</Tag><span className="text-[10px] text-slate-300 italic">{g.partyA.date}</span></div><div className="text-sm font-medium text-slate-700">{g.partyA.content}</div></div>{g.replies?.map((r, ri) => (<div key={ri} className="mt-3 pt-3 border-t border-slate-50"><div className="flex justify-between items-center mb-1"><Tag color="blue" className="text-[10px]">é¡¹ç›®ç»„å›å¤</Tag><span className="text-[10px] text-slate-300 italic">{r.date}</span></div><div className="text-sm text-slate-500">{r.content}</div></div>))}</div>)}))} />
                                </div>
                            </Card>
                            <Card id="issues-anchor" title={sectionTitle(<TeamOutlined />, "åè°ƒäº‹é¡¹è¿½è¸ª", "text-orange-500")}>
                                {userRole === 'team' && <div className="mb-6"><Input.Search size="large" placeholder="è®°å½•å¾…ç”²æ–¹é…åˆäº‹é¡¹..." enterButton="æ–°å¢" onSearch={onAddIssue} /></div>}
                                <div className="space-y-4 max-h-[400px] overflow-auto custom-scroll pr-2">
                                    {(current.issues || []).map(issue => (
                                        <div key={issue.id} className={`p-3 rounded-lg border ${issue.status === 'done' ? 'bg-slate-50 border-slate-100' : 'bg-orange-50 border-orange-100'}`}>
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1"><Tag color={issue.status === 'done' ? 'default' : 'orange'}>{issue.status === 'done' ? 'å·²å¤„ç†' : 'éœ€é…åˆ'}</Tag><div className={`text-sm mt-2 font-bold ${issue.status === 'done' ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{issue.title}</div></div>
                                                {userRole === 'team' && <Button size="small" type="primary" className={issue.status === 'done' ? 'bg-slate-400 border-none' : 'bg-green-600 border-none'} onClick={() => onToggleIssue(issue.id)}>{issue.status === 'done' ? 'æ¿€æ´»' : 'æ ‡è®°å®Œæˆ'}</Button>}
                                            </div>
                                            <div className="text-[9px] text-slate-400 mt-2 font-sans italic">ğŸ“… å‘èµ·ï¼š{issue.date} {issue.status === 'done' && ` | âœ”ï¸ è§£å†³ï¼š${issue.solvedDate}`}</div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('login');
            const [userRole, setUserRole] = useState('team');
            const [user, setUser] = useState(null);
            const [modules, setModules] = useState([]);
            const [loading, setLoading] = useState(true);
            const [db, setDb] = useState(null);
            const [connError, setConnError] = useState(null);
            const [selectedId, setSelectedId] = useState(null);
            const [searchText, setSearchText] = useState('');
            const [filterMode, setFilterMode] = useState('all');
            
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [isDocModalOpen, setIsDocModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isProjectInfoModalOpen, setIsProjectInfoModalOpen] = useState(false);
            const [isWeeklyReportModalOpen, setIsWeeklyReportModalOpen] = useState(false);
            const [isEditingProjectInfo, setIsEditingProjectInfo] = useState(false);
            const [projectInfo, setProjectInfo] = useState({});
            const [weeklyReports, setWeeklyReports] = useState([]);
            const [importFileList, setImportFileList] = useState([]);
            const [importLoading, setImportLoading] = useState(false);
            const [docFileList, setDocFileList] = useState([]);
            const [selectedExportIds, setSelectedExportIds] = useState([]);
            const isDeletingAll = useRef(false);
            const hasInitialized = useRef(false);
            const [form] = Form.useForm();
            const [docForm] = Form.useForm();
            const [infoForm] = Form.useForm();
            const [weeklyForm] = Form.useForm();
            const strategyTypeWatcher = Form.useWatch('strategyType', form);

            const current = useMemo(() => modules.find(m => m.id === selectedId) || null, [modules, selectedId]);

            const stats = useMemo(() => {
                const total = modules.length;
                const completed = modules.filter(m => (m.progress || 0) === 100).length;
                const totalProgress = total > 0 ? Math.round(modules.reduce((a, b) => a + (b.progress || 0), 0) / total) : 0;
                const pendingIssues = modules.reduce((a, b) => a + (b.issues?.filter(i => i.status === 'pending').length || 0), 0);
                const totalFeedback = modules.reduce((a, b) => a + (b.feedbackGroups || []).filter(g => (g.replies || []).length === 0).length, 0);
                const subsystemCount = new Set(modules.map(m => m.subsystem)).size;
                const completedSubsystems = Object.values(modules.reduce((acc, m) => { acc[m.subsystem] = acc[m.subsystem] || []; acc[m.subsystem].push(m); return acc; }, {})).filter(g => g.every(m => m.progress === 100)).length;
                const delayedCount = modules.filter(m => dayjs().isAfter(dayjs(m.deadline)) && (m.progress || 0) < 100).length;
                const strategyCounts = modules.reduce((acc, cur) => { const type = cur.strategyType || 'development'; acc[type] = (acc[type] || 0) + 1; return acc; }, {});
                return { total, completed, totalProgress, pendingIssues, totalFeedback, subsystemCount, completedSubsystems, strategyCounts, delayedCount };
            }, [modules]);

            const handleLogin = (r) => { setUserRole(r); sessionStorage.setItem('board_user_role', r); sessionStorage.setItem('board_is_logged', 'true'); setView('list'); };
            const handleLogout = () => { sessionStorage.clear(); setView('login'); };

            const onInfoValuesChange = (changedValues, allValues) => {
                if (changedValues.trialStart || changedValues.trialPeriod) {
                    const start = allValues.trialStart;
                    const period = allValues.trialPeriod;
                    if (start && period) {
                        const end = dayjs(start).add(period, 'month');
                        infoForm.setFieldsValue({ trialEnd: end });
                    }
                }
            };

            const SEED_DATA = [{ subsystem: 'åŸºç¡€æ”¯æ’‘å­ç³»ç»Ÿ', name: 'ç”¨æˆ·ç®¡ç†', chapter: 'ç¬¬ä¸€èŠ‚', status: 'è¿›è¡Œä¸­', progress: 35, deadline: '2026-03-12', order: 0, link: '', strategyType: 'customization' }];

            useEffect(() => {
                const initCloud = async () => {
                    try {
                        const { initializeApp, getAuth, signInAnonymously, getFirestore, onAuthStateChanged, signInWithCustomToken } = window.FirebaseSDK;
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const dbInstance = getFirestore(app);
                        setDb(dbInstance);
                        const savedRole = sessionStorage.getItem('board_user_role');
                        if (savedRole) setUserRole(savedRole);
                        if (initialToken) await signInWithCustomToken(auth, initialToken);
                        else await signInAnonymously(auth);
                        onAuthStateChanged(auth, (u) => { if (u) { setUser(u); if (sessionStorage.getItem('board_is_logged')) setView('list'); } });
                    } catch (e) { setConnError('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥'); }
                }; initCloud();
            }, []);

            useEffect(() => {
                if (!db || !user) return;
                const { collection, onSnapshot, query, addDoc, doc } = window.FirebaseSDK;
                const modulesCol = collection(db, 'artifacts', appId, 'public', 'data', 'modules');
                const unsubModules = onSnapshot(query(modulesCol), (snapshot) => {
                    if (snapshot.empty && !isDeletingAll.current && !hasInitialized.current) {
                        hasInitialized.current = true;
                        SEED_DATA.forEach(item => addDoc(modulesCol, item));
                        setModules([]); setLoading(false);
                    } else {
                        hasInitialized.current = true;
                        setModules(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false); isDeletingAll.current = false;
                    }
                }, (err) => { setConnError('æ•°æ®åŒæ­¥å¼‚å¸¸'); });
                const infoDoc = doc(db, 'artifacts', appId, 'public', 'data', 'projectSettings', 'basicInfo');
                const unsubInfo = onSnapshot(infoDoc, (snap) => { if(snap.exists()) setProjectInfo(snap.data()); });
                const weeklyCol = collection(db, 'artifacts', appId, 'public', 'data', 'weeklyReports');
                const unsubWeekly = onSnapshot(query(weeklyCol), (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setWeeklyReports(data.sort((a,b) => dayjs(b.uploadTime).unix() - dayjs(a.uploadTime).unix()));
                });
                return () => { unsubModules(); unsubInfo(); unsubWeekly(); };
            }, [db, user]);

            const updateSubItem = async (id, field, newData) => {
                if (!user) return;
                const { doc, setDoc } = window.FirebaseSDK;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'modules', id), { [field]: newData }, { merge: true });
            };

            const deleteModule = async (id) => {
                if (!user) return;
                const { doc, deleteDoc } = window.FirebaseSDK;
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'modules', id)); message.success('å·²åˆ é™¤'); } catch (e) { message.error('å¤±è´¥'); }
            };

            const handleDeleteAll = async () => {
                if (!user || modules.length === 0) return;
                const { doc, deleteDoc } = window.FirebaseSDK;
                isDeletingAll.current = true;
                try {
                    const hide = message.loading('æ¸…é™¤ä¸­...', 0);
                    await Promise.all(modules.map(m => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'modules', m.id))));
                    hide(); message.success('æ•°æ®å·²æ¸…ç©º');
                } catch (e) { isDeletingAll.current = false; message.error('å¤±è´¥'); }
            };

            const saveModule = async (vals) => {
                if (!user) return;
                const { doc, setDoc, addDoc, collection } = window.FirebaseSDK;
                const ssName = Array.isArray(vals.subsystem) ? vals.subsystem[0] : vals.subsystem;
                const d = vals.deadline ? vals.deadline.format('YYYY-MM-DD') : '';
                const history = [...(current?.history || [])];
                if (current && vals.progress !== current.progress) {
                    history.unshift({ time: dayjs().format('YYYY/M/D HH:mm'), content: `[ç³»ç»Ÿå®¡è®¡] è¿›åº¦ä» ${current.progress}% è°ƒæ•´ä¸º ${vals.progress}%` });
                }
                const payload = { ...vals, status: vals.progress === 100 ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­', history, subsystem: ssName || 'æœªåˆ†ç±»', deadline: d, updateTime: dayjs().format('YYYY/M/D'), link: vals.link || '', tender: vals.tender || '', strategy: vals.strategy || '', chapter: vals.chapter || '', modifiedModules: vals.modifiedModules || '' };
                try {
                    if (selectedId) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'modules', selectedId), payload, { merge: true });
                        message.success('æ›´æ–°æˆåŠŸ');
                    } else {
                        const maxOrder = modules.reduce((max, m) => Math.max(max, m.order || 0), -1);
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'modules'), { ...payload, history: [], docs: [], issues: [], order: maxOrder + 1 });
                        message.success('åˆ›å»ºæˆåŠŸ');
                    }
                    setIsEditModalOpen(false);
                } catch (e) { message.error('é”™è¯¯'); }
            };

            const handleSaveProjectInfo = async (vals) => {
                const { doc, setDoc } = window.FirebaseSDK;
                const formatted = {};
                Object.keys(vals).forEach(k => {
                    if(vals[k] && dayjs.isDayjs(vals[k])) formatted[k] = vals[k].format('YYYY-MM-DD');
                    else formatted[k] = vals[k] || '';
                });
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projectSettings', 'basicInfo'), formatted, { merge: true });
                    message.success('é¡¹ç›®ä¿¡æ¯å·²æ›´æ–°');
                    setIsEditingProjectInfo(false);
                } catch(e) { message.error('ä¿å­˜å¤±è´¥'); }
            };

            const handleUploadWeeklyReport = (vals) => {
                const file = vals.file.fileList[0]?.originFileObj;
                if(!file) return message.error('è¯·é€‰æ‹©æ–‡ä»¶');
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const { collection, addDoc } = window.FirebaseSDK;
                    const weekNum = vals.weekNum;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'weeklyReports'), {
                        name: `ç¬¬${weekNum}å‘¨é¡¹ç›®å‘¨æŠ¥`,
                        weekNum: weekNum,
                        uploadTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
                        url: e.target.result,
                        fileName: file.name
                    });
                    message.success('å‘¨æŠ¥å½’æ¡£æˆåŠŸ');
                    setIsWeeklyReportModalOpen(false);
                    weeklyForm.resetFields();
                }; reader.readAsDataURL(file);
            };

            const handleDownloadReport = (r) => { const link = document.createElement('a'); link.href = r.url; link.download = r.name + r.fileName.substring(r.fileName.lastIndexOf('.')); link.click(); };

            const handleDownloadTemplate = () => {
                const data = [["å­ç³»ç»Ÿåç§°", "æ¨¡å—åç§°", "æ ‡ä¹¦ç« èŠ‚", "å“åº”ç­–ç•¥", "è¿›åº¦", "è®¡åˆ’æˆªæ­¢æ—¥æœŸ", "æ ‡ä¹¦æŒ‡æ ‡", "å®æ–½ç­–ç•¥", "é“¾æ¥", "æ¶‰åŠæ”¹é€ æ¨¡å—"]];
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), "æ¨¡ç‰ˆ"); XLSX.writeFile(wb, "çœ‹æ¿å¯¼å…¥æ¨¡ç‰ˆ.xlsx");
            };

            const handleImportConfirm = async () => {
                if (!importFileList.length) return;
                setImportLoading(true);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                        const rows = json.slice(1);
                        const { collection, addDoc } = window.FirebaseSDK;
                        const col = collection(db, 'artifacts', appId, 'public', 'data', 'modules');
                        const maxOrder = modules.reduce((max, m) => Math.max(max, m.order || 0), -1);
                        let nextOrder = maxOrder + 1;
                        for (const row of rows) {
                            if (!row[1]) continue;
                            const map = { 'ç°æœ‰äº§å“æ”¹é€ ': 'customization', 'é‡æ–°å®šåˆ¶å¼€å‘': 'development', 'é«˜ä¿çœŸDEMO': 'demo', 'æ–‡å­—è¯´æ˜å“åº”': 'text_description' };
                            let p = row[4];
                            let progressVal = (typeof p === 'string' && p.includes('%')) ? parseFloat(p) : (typeof p === 'number' && p <= 1 ? p * 100 : Number(p || 0));
                            let d = (row[5] instanceof Date) ? dayjs(row[5]).format('YYYY-MM-DD') : String(row[5] || '');
                            await addDoc(col, { subsystem: row[0] || 'æœªåˆ†ç»„', name: String(row[1]), chapter: row[2] || '', strategyType: map[row[3]] || 'development', progress: progressVal, deadline: d, tender: row[6] || '', strategy: row[7] || '', link: row[8] || '', modifiedModules: row[9] || '', status: (progressVal === 100) ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­', order: nextOrder++, issues: [], feedbackGroups: [], docs: [], history: [], updateTime: dayjs().format('YYYY/M/D') });
                        }
                        message.success('å¯¼å…¥å®Œæˆ'); setIsImportModalOpen(false); setImportFileList([]);
                    } catch (err) { message.error('å¤±è´¥'); } finally { setImportLoading(false); }
                }; reader.readAsArrayBuffer(importFileList[0]);
            };

            const handleBatchExport = () => {
                if (!selectedExportIds.length) return message.error('æœªé€‰');
                const data = modules.filter(m => selectedExportIds.includes(m.id)).sort((a,b) => (a.order || 0) - (b.order || 0));
                const map = { customization: 'ç°æœ‰äº§å“æ”¹é€ ', development: 'å®šåˆ¶', demo: 'DEMO', text_description: 'æ–‡å­—è¯´æ˜å“åº”' };
                const wsData = [["å­ç³»ç»Ÿ", "æ¨¡å—", "ç« èŠ‚", "ç­–ç•¥", "è¿›åº¦", "æˆªæ­¢", "æ ‡ä¹¦", "æ–¹æ¡ˆ", "é“¾æ¥", "æ”¹é€ å"], ...data.map(m => [m.subsystem, m.name, m.chapter, map[m.strategyType], m.progress, m.deadline, m.tender, m.strategy, m.link, m.modifiedModules])];
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "æ•°æ®"); XLSX.writeFile(wb, `å¯¼å‡º_${dayjs().format('MMDDHHmm')}.xlsx`); setIsExportModalOpen(false);
            };

            const handleFinishDoc = (v) => {
                if (!docFileList.length) return message.error('è¯·é€‰æ–‡ä»¶');
                const file = docFileList[0];
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'image/jpeg', 'image/png', 'application/zip', 'application/x-rar-compressed'];
                if (!allowedTypes.includes(file.type) && !file.name.endsWith('.rar')) return message.error('æ ¼å¼æš‚ä¸æ”¯æŒ');
                if (file.size > 700 * 1024) return message.error('å•æ–‡ä»¶ 700KB é™åˆ¶');
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const sizeStr = file.size > 1024 * 1024 ? (file.size / (1024 * 1024)).toFixed(2) + ' MB' : (file.size / 1024).toFixed(2) + ' KB';
                    const newDoc = { name: file.name, type: v.type, date: dayjs().format('YYYY/MM/DD'), size: sizeStr, url: e.target.result };
                    try { const hide = message.loading('åŒæ­¥ä¸­...', 0); await updateSubItem(selectedId, 'docs', [...(current.docs || []), newDoc]); hide(); message.success('å½’æ¡£æˆåŠŸ'); setIsDocModalOpen(false); setDocFileList([]); docForm.resetFields(); } catch (err) { message.error('ä¸Šä¼ å¤±è´¥'); }
                }; reader.readAsDataURL(file);
            };

            return (
                <ConfigProvider theme={{ token: { colorPrimary: '#3b82f6', borderRadius: 12 } }}>
                    {view === 'login' ? <LoginView onLogin={handleLogin} projectInfo={projectInfo} /> : (
                        view === 'list' ? (
                            <ListView 
                                modules={modules} stats={stats} filterMode={filterMode} onFilterChange={setFilterMode} searchText={searchText} onSearchChange={setSearchText} onSelect={(id) => { setSelectedId(id); setView('detail'); }} onLogout={handleLogout} userRole={userRole} 
                                onAdd={() => { setSelectedId(null); setIsEditModalOpen(true); form.resetFields(); }} 
                                onImport={() => setIsImportModalOpen(true)} 
                                onExport={() => { setSelectedExportIds(modules.map(m => m.id)); setIsExportModalOpen(true); }} 
                                onDelete={deleteModule} onDeleteAll={handleDeleteAll} 
                                onReorderModules={async (did, tid, tss) => {
                                    const { doc, writeBatch } = window.FirebaseSDK; const batch = writeBatch(db);
                                    const sorted = [...modules].sort((a,b) => (a.order || 0) - (b.order || 0));
                                    const dragged = sorted.find(m => m.id === did); if(!dragged) return;
                                    const others = sorted.filter(m => m.id !== did);
                                    let nidx = tid ? others.findIndex(m => m.id === tid) : others.length;
                                    others.splice(nidx, 0, { ...dragged, subsystem: tss });
                                    others.forEach((m, idx) => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'modules', m.id), { order: idx, subsystem: m.subsystem }); });
                                    await batch.commit();
                                }} 
                                onReorderSubsystems={async (dss, tss) => {
                                    const { doc, writeBatch } = window.FirebaseSDK; const batch = writeBatch(db);
                                    const ssOrder = [...new Set([...modules].sort((a,b) => (a.order || 0) - (b.order || 0)).map(m => m.subsystem))];
                                    const fidx = ssOrder.indexOf(dss); const tidx = ssOrder.indexOf(tss); ssOrder.splice(fidx, 1); ssOrder.splice(tidx, 0, dss);
                                    let gidx = 0; const grouped = modules.reduce((acc, m) => { acc[m.subsystem] = acc[m.subsystem] || []; acc[m.subsystem].push(m); return acc; }, {});
                                    ssOrder.forEach(ss => { const mList = grouped[ss].sort((a,b) => (a.order || 0) - (b.order || 0)); mList.forEach(m => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'modules', m.id), { order: gidx++ }); }); });
                                    await batch.commit();
                                }} 
                                onOpenProjectInfo={() => { setIsEditingProjectInfo(false); setIsProjectInfoModalOpen(true); }}
                                onOpenWeeklyReports={() => setIsWeeklyReportModalOpen(true)}
                                projectInfo={projectInfo}
                            />
                        ) : (
                            <DetailView current={current} onBack={() => setView('list')} onEdit={() => { if(!current) return; form.setFieldsValue({ ...current, deadline: current.deadline ? dayjs(current.deadline) : null }); setIsEditModalOpen(true); }} onAddHistory={(v) => current && updateSubItem(selectedId, 'history', [{ time: dayjs().format('YYYY/M/D HH:mm'), content: `[${userRole === 'team' ? 'é¡¹ç›®ç»„' : 'ç”²æ–¹'}] ${v}` }, ...(current.history || [])])} onAddIssue={(v) => current && updateSubItem(selectedId, 'issues', [{ id: Date.now(), title: v, status: 'pending', date: dayjs().format('YYYY/M/D') }, ...(current.issues || [])])} onToggleIssue={(iid) => current && updateSubItem(selectedId, 'issues', (current.issues || []).map(i => i.id === iid ? { ...i, status: i.status === 'done' ? 'pending' : 'done', solvedDate: i.status === 'done' ? '' : dayjs().format('YYYY/M/D') } : i))} onDeleteDoc={(idx) => current && updateSubItem(selectedId, 'docs', (current.docs || []).filter((_, i) => i !== idx))} onOpenDocModal={() => setIsDocModalOpen(true)} userRole={userRole} feedbackProps={{ onSubmitInteraction: (v) => { if(!current) return; const time = dayjs().format('YYYY/M/D HH:mm'); if(userRole === 'partyA') updateSubItem(selectedId, 'feedbackGroups', [{ partyA: { content: v, date: time }, replies: [] }, ...(current.feedbackGroups || [])]); else if(current.feedbackGroups?.length) { const groups = [...current.feedbackGroups]; groups[0].replies.push({ content: v, date: time }); updateSubItem(selectedId, 'feedbackGroups', groups); } }}} />
                        )
                    )}

                    <Modal 
                        title={(isEditingProjectInfo && userRole === 'team') ? "ç»´æŠ¤é¡¹ç›®åŸºæœ¬ä¿¡æ¯" : "é¡¹ç›®åŸºæœ¬æƒ…å†µ"} 
                        open={isProjectInfoModalOpen} 
                        onCancel={() => { setIsProjectInfoModalOpen(false); setIsEditingProjectInfo(false); }} 
                        width={900} 
                        destroyOnClose 
                        footer={(isEditingProjectInfo && userRole === 'team') ? [
                            <Button key="back" onClick={() => setIsEditingProjectInfo(false)}>è¿”å›å±•ç¤º</Button>,
                            <Button key="submit" type="primary" onClick={() => infoForm.submit()}>ä¿å­˜ä¿®æ”¹</Button>
                        ] : [<Button key="close" onClick={() => setIsProjectInfoModalOpen(false)}>å…³é—­</Button>]}
                    >
                        {(!isEditingProjectInfo || userRole !== 'team') ? (
                            <div className="fade-in py-2">
                                <div className="flex justify-between items-start mb-6">
                                    <div className="flex-1 pr-10">
                                        <h2 className="text-2xl font-extrabold text-slate-800 m-0">{projectInfo.name || 'æœªå‘½åé¡¹ç›®'}</h2>
                                        <div className="mt-3 text-slate-500 text-sm leading-relaxed whitespace-pre-wrap">{projectInfo.intro || 'æš‚æ— é¡¹ç›®ç®€ä»‹è¯´æ˜ã€‚'}</div>
                                    </div>
                                    {userRole === 'team' && (
                                        <Button icon={<SettingOutlined />} type="primary" ghost onClick={() => { setIsEditingProjectInfo(true); }}>ä¿¡æ¯ç»´æŠ¤</Button>
                                    )}
                                </div>
                                <Descriptions bordered column={2} size="small" className="mb-8" labelStyle={{ width: '160px', background: '#f8fafc', fontWeight: 'bold' }}>
                                    <Descriptions.Item label="é¡¹ç›®å•ä½ (ç”²æ–¹)" span={1}>{projectInfo.clientUnit || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="æ‰¿æ‹…å•ä½ (ä¹™æ–¹)" span={1}>{projectInfo.contractorUnit || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="ç›‘ç†å•ä½" span={2}>{projectInfo.supervisionUnit || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="åˆåŒç­¾è®¢æ—¥æœŸ">{projectInfo.contractDate || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="é¡¹ç›®å¼€å·¥æ—¥æœŸ">{projectInfo.startDate || '-'}</Descriptions.Item>
                                </Descriptions>
                                <Descriptions bordered column={2} size="small" className="mb-8" title={<Tag className="section-tag">éªŒæ”¶é˜¶æ®µè¯¦æƒ…</Tag>} labelStyle={{ width: '160px', background: '#f8fafc', fontWeight: 'bold' }}>
                                    <Descriptions.Item label="é¡¹ç›®åˆéªŒ (è®¡åˆ’)">{projectInfo.prePlanned || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="é¡¹ç›®åˆéªŒ (å®é™…)">{projectInfo.preActual || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="è¯•è¿è¡Œæ—¶é—´" span={2}><span className="text-blue-600 font-bold">{projectInfo.trialPeriod || 0}ä¸ªæœˆ</span> {(projectInfo.trialStart && projectInfo.trialEnd) ? <span className="ml-2 text-slate-400 font-normal"> (è‡ª {projectInfo.trialStart} è‡³ {projectInfo.trialEnd})</span> : <span className="ml-2 text-slate-300 font-normal"> (æœªè®¾ç½®æ—¥æœŸåŒºé—´)</span>}</Descriptions.Item>
                                    <Descriptions.Item label="é¡¹ç›®ç»ˆéªŒ (è®¡åˆ’)">{projectInfo.finalPlanned || '-'}</Descriptions.Item>
                                    <Descriptions.Item label="é¡¹ç›®ç»ˆéªŒ (å®é™…)">{projectInfo.finalActual || '-'}</Descriptions.Item>
                                </Descriptions>
                            </div>
                        ) : (
                            <Form form={infoForm} layout="vertical" onFinish={handleSaveProjectInfo} onValuesChange={onInfoValuesChange} className="fade-in">
                                <Row gutter={24}>
                                    <Col span={24}><Tag className="section-tag mb-4">æ ¸å¿ƒä¿¡æ¯ç»´æŠ¤</Tag></Col>
                                    <Col span={12}><Form.Item name="name" label="é¡¹ç›®åç§°"><Input placeholder="è¯·è¾“å…¥é¡¹ç›®å…¨ç§°" /></Form.Item></Col>
                                    <Col span={12}><Form.Item name="clientUnit" label="é¡¹ç›®å•ä½ (ç”²æ–¹)"><Input /></Form.Item></Col>
                                    <Col span={12}><Form.Item name="contractorUnit" label="æ‰¿æ‹…å•ä½ (ä¹™æ–¹)"><Input /></Form.Item></Col>
                                    <Col span={12}><Form.Item name="supervisionUnit" label="ç›‘ç†å•ä½"><Input /></Form.Item></Col>
                                    <Col span={24}><Form.Item name="intro" label="é¡¹ç›®ç®€ä»‹"><Input.TextArea rows={3} placeholder="æè¿°å»ºè®¾ç›®æ ‡åŠèƒŒæ™¯" /></Form.Item></Col>
                                    <Col span={12}><Form.Item name="contractDate" label="åˆåŒç­¾è®¢æ—¥æœŸ"><DatePicker className="w-full" /></Form.Item></Col>
                                    <Col span={12}><Form.Item name="startDate" label="é¡¹ç›®å¼€å·¥æ—¥æœŸ" dependencies={['contractDate']} rules={[{ validator: async (_, value) => { const contract = infoForm.getFieldValue('contractDate'); if (value && contract && value.isBefore(contract, 'day')) { return Promise.reject(new Error('å¼€å·¥æ—¥æœŸä¸åº”æ—©äºåˆåŒç­¾è®¢æ—¥æœŸ')); } } }]}><DatePicker className="w-full" /></Form.Item></Col>
                                    <Col span={24}><Divider orientation="left" className="m-0 text-slate-400 text-xs">é‡Œç¨‹ç¢‘èŠ‚ç‚¹ç»´æŠ¤</Divider></Col>
                                    <Col span={12}><Form.Item name="prePlanned" label="é¡¹ç›®åˆéªŒ (è®¡åˆ’æ—¥æœŸ)" dependencies={['startDate']} rules={[{ validator: async (_, value) => { const start = infoForm.getFieldValue('startDate'); if (value && start && value.isBefore(start, 'day')) { return Promise.reject(new Error('åˆéªŒæ—¥æœŸä¸åº”æ—©äºå¼€å·¥æ—¥æœŸ')); } } }]}><DatePicker className="w-full" /></Form.Item></Col>
                                    <Col span={12}><Form.Item name="preActual" label="é¡¹ç›®åˆéªŒ (å®é™…æ—¥æœŸ)" dependencies={['startDate']} rules={[{ validator: async (_, value) => { const start = infoForm.getFieldValue('startDate'); if (value && start && value.isBefore(start, 'day')) { return Promise.reject(new Error('åˆéªŒæ—¥æœŸä¸åº”æ—©äºå¼€å·¥æ—¥æœŸ')); } } }]}><DatePicker className="w-full" /></Form.Item></Col>
                                    <Col span={24}><Divider orientation="left" className="m-0 text-slate-400 text-xs">è¯•è¿è¡Œè¯¦æƒ…</Divider></Col>
                                    <Col span={24}><Form.Item name="trialPeriod" label="è¯•è¿è¡Œå‘¨æœŸ (æœˆ)" initialValue={3}><InputNumber min={1} max={60} precision={0} style={{ width: '120px' }} /></Form.Item></Col>
                                    <Col span={8}><Form.Item name="trialStart" label="è¯•è¿è¡Œå¼€å§‹æ—¥æœŸ" dependencies={['preActual', 'prePlanned']} rules={[{ validator: async (_, value) => { const pre = infoForm.getFieldValue('preActual') || infoForm.getFieldValue('prePlanned'); if (value && pre && value.isBefore(pre, 'day')) { return Promise.reject(new Error('è¯•è¿è¡Œå¼€å§‹æ—¥æœŸä¸èƒ½æ—©äºåˆéªŒæ—¥æœŸ')); } } }]}><DatePicker className="w-full" /></Form.Item></Col>
                                    <Col span={8}><Form.Item name="trialEnd" label="è¯•è¿è¡Œç»“æŸæ—¥æœŸ (è‡ªåŠ¨è®¡ç®—)"><DatePicker className="w-full" disabled /></Form.Item></Col>
                                    <Col span={8} className="flex items-center text-slate-400 text-[10px] italic pt-6">* è‡ªåŠ¨æ¨ç®—</Col>
                                    <Col span={24}><Divider orientation="left" className="m-0 text-slate-400 text-xs">ç»ˆéªŒç»´æŠ¤</Divider></Col>
                                    <Col span={12}><Form.Item name="finalPlanned" label="é¡¹ç›®ç»ˆéªŒ (è®¡åˆ’æ—¥æœŸ)" dependencies={['trialEnd']} rules={[{ validator: async (_, value) => { const end = infoForm.getFieldValue('trialEnd'); if (value && end && value.isBefore(end, 'day')) { return Promise.reject(new Error('ç»ˆéªŒæ—¥æœŸä¸èƒ½æ—©äºè¯•è¿è¡Œç»“æŸæ—¥æœŸ')); } } }]}><DatePicker className="w-full" /></Form.Item></Col>
                                    <Col span={12}><Form.Item name="finalActual" label="é¡¹ç›®ç»ˆéªŒ (å®é™…æ—¥æœŸ)" dependencies={['trialEnd']} rules={[{ validator: async (_, value) => { const end = infoForm.getFieldValue('trialEnd'); if (value && end && value.isBefore(end, 'day')) { return Promise.reject(new Error('ç»ˆéªŒæ—¥æœŸä¸èƒ½æ—©äºè¯•è¿è¡Œç»“æŸæ—¥æœŸ')); } } }]}><DatePicker className="w-full" /></Form.Item></Col>
                                </Row>
                            </Form>
                        )}
                    </Modal>

                    <Modal title="é¡¹ç›®å‘¨æŠ¥ç®¡ç†" open={isWeeklyReportModalOpen} onCancel={() => setIsWeeklyReportModalOpen(false)} footer={null} width={700}>
                        {userRole === 'team' && (
                            <div className="bg-slate-50 p-4 rounded-xl mb-6">
                                <Form form={weeklyForm} layout="inline" onFinish={handleUploadWeeklyReport}>
                                    <Form.Item name="weekNum" label="å‘¨æ¬¡" rules={[{required: true, message: 'è¯·è¾“å…¥å‘¨æ¬¡'}]}><InputNumber placeholder="å¦‚: 12" min={1} /></Form.Item>
                                    <Form.Item name="file" label="æ–‡ä»¶" rules={[{required: true, message: 'è¯·é€‰æ‹©æ–‡ä»¶'}]}><Upload beforeUpload={() => false} maxCount={1}><Button icon={<UploadOutlined />}>é€‰æ‹©å‘¨æŠ¥</Button></Upload></Form.Item>
                                    <Form.Item><Button type="primary" htmlType="submit">ä¸Šä¼ å½’æ¡£</Button></Form.Item>
                                </Form>
                            </div>
                        )}
                        <List dataSource={weeklyReports} className="max-h-[400px] overflow-auto custom-scroll" renderItem={item => (<List.Item extra={<Button type="link" icon={<DownloadOutlined />} onClick={() => handleDownloadReport(item)}>ä¸‹è½½</Button>}><List.Item.Meta avatar={<Avatar icon={<AuditOutlined />} className="bg-indigo-100 text-indigo-600" />} title={<span className="font-bold">{item.name}</span>} description={<span className="text-xs text-slate-400">ä¸Šä¼ æ—¶é—´ï¼š{item.uploadTime}</span>} /></List.Item>)} />
                    </Modal>

                    <Modal title="æ‰¹é‡å¯¼å‡º" open={isExportModalOpen} onCancel={() => setIsExportModalOpen(false)} onOk={handleBatchExport} width={600} cancelText="å–æ¶ˆ"><div className="flex justify-between items-center mb-4"><span className="text-xs">å·²é€‰ {selectedExportIds.length} é¡¹</span><Checkbox checked={selectedExportIds.length === modules.length} onChange={(e) => setSelectedExportIds(e.target.checked ? modules.map(m => m.id) : [])}>å…¨é€‰</Checkbox></div><div className="max-h-96 overflow-y-auto"><Checkbox.Group className="w-full" value={selectedExportIds} onChange={setSelectedExportIds}><Row gutter={[8, 8]}>{modules.map(m => <Col span={12} key={m.id}><div className="p-2 border rounded"><Checkbox value={m.id} className="text-xs">{m.name}</Checkbox></div></Col>)}</Row></Checkbox.Group></div></Modal>
                    <Modal title="å¯¼å…¥" open={isImportModalOpen} onCancel={() => setIsImportModalOpen(false)} onOk={handleImportConfirm} loading={importLoading} okText="ç¡®è®¤å¯¼å…¥" cancelText="å–æ¶ˆ"><Space direction="vertical" className="w-full py-4"><Button type="link" icon={<DownloadOutlined />} onClick={handleDownloadTemplate}>ä¸‹è½½æ ‡å‡†å¯¼å…¥æ¨¡ç‰ˆ</Button><Upload.Dragger multiple={false} fileList={importFileList} beforeUpload={(f) => { setImportFileList([f]); return false; }} onRemove={() => setImportFileList([])}><p className="ant-upload-text">é€‰æ‹©æ–‡ä»¶</p></Upload.Dragger></Space></Modal>
                    <Modal title="å½’æ¡£æ¨¡å—æ–‡æ¡£" open={isDocModalOpen} onOk={() => docForm.submit()} onCancel={() => setIsDocModalOpen(false)} okText="ç¡®è®¤å½’æ¡£" cancelText="å–æ¶ˆ"><Form form={docForm} layout="vertical" onFinish={handleFinishDoc}><Form.Item label="é€‰æ‹©æœ¬åœ°æ–‡ä»¶" required><Upload fileList={docFileList} beforeUpload={f => {setDocFileList([f]); return false}} onRemove={() => setDocFileList([])} accept={ALLOWED_EXTS.join(',')}><Button icon={<UploadOutlined />}>é€‰æ‹©æ–‡ä»¶</Button></Upload><div className="text-[10px] text-slate-400 mt-1">å•æ–‡ä»¶å»ºè®®ä¸è¶…è¿‡ 700KB</div></Form.Item><Form.Item name="type" label="æ–‡æ¡£ç±»å‹" rules={[{ required: true }]} initialValue="éœ€æ±‚æ–‡æ¡£"><Select options={DOC_TYPES.map(t => ({ label: t, value: t }))} /></Form.Item></Form></Modal>
                    <Modal title={selectedId ? "ç¼–è¾‘" : "æ–°å¢"} open={isEditModalOpen} onOk={() => form.submit()} onCancel={() => setIsEditModalOpen(false)} width={650} destroyOnClose okText="ç¡®è®¤ä¿å­˜" cancelText="å–æ¶ˆ"><Form form={form} layout="vertical" onFinish={saveModule}><Row gutter={16}><Col span={12}><Form.Item name="subsystem" label="æ‰€å±å­ç³»ç»Ÿ" rules={[{ required: true }]}><Select mode="tags" options={[...new Set(modules.map(m => m.subsystem))].map(s => ({label:s,value:s}))} /></Form.Item></Col><Col span={12}><Form.Item name="name" label="æ¨¡å—åç§°" rules={[{ required: true }]}><Input /></Form.Item></Col></Row><Form.Item name="strategyType" label="å“åº”ç­–ç•¥" rules={[{ required: true }]}><Select options={STRATEGY_OPTIONS} /></Form.Item>{strategyTypeWatcher === 'customization' && <Form.Item name="modifiedModules" label="æ¶‰åŠæ”¹é€ æ¨¡å—"><Input /></Form.Item>}<Form.Item name="link" label="è®¿é—®é“¾æ¥"><Input /></Form.Item><Row gutter={16}><Col span={12}><Form.Item name="progress" label="è¿›åº¦" initialValue={0}><InputNumber min={0} max={100} className="w-full" /></Form.Item></Col><Col span={12}><Form.Item name="deadline" label="æˆªæ­¢æ—¥æœŸ" rules={[{ required: true }]}><DatePicker className="w-full" /></Form.Item></Col></Row><Form.Item name="tender" label="æ ‡ä¹¦åŸæ–‡"><Input.TextArea rows={2} /></Form.Item><Form.Item name="strategy" label="å…·ä½“å®æ–½ç­–ç•¥"><Input.TextArea rows={2} /></Form.Item></Form></Modal>
                </ConfigProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>