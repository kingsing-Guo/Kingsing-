<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>全民参保数智动员手机看板</title>
  <style>
    :root {
      --text: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --line: #e2e8f0;
      --ok: #059669;
      --warn: #b45309;
      --bg-shell: #17181c;
      --bg-app: #f3f5f8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg-shell);
      font-family: "PingFang SC", "Noto Sans SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
      display: flex;
      justify-content: center;
      min-height: 100dvh;
      padding: 14px 0;
    }
    html { scroll-behavior: smooth; }
    .app {
      width: min(480px, 100vw - 20px);
      min-height: 100dvh;
      background: var(--bg-app);
      border-radius: 28px;
      padding: 14px 14px 96px;
      box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 20px 50px rgba(0,0,0,.35);
      position: relative;
    }
    .top {
      background: #fff;
      border: 1px solid #e7edf7;
      border-radius: 24px;
      padding: 16px;
      box-shadow: 0 3px 0 rgba(15,23,42,.04), 0 12px 30px rgba(15,23,42,.08);
    }
    .top-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 700;
      color: #2563eb;
    }
    .status {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      background: #edf2f8;
      color: #94a3b8;
      display: grid;
      place-items: center;
      position: relative;
      font-size: 18px;
    }
    .status:after {
      content: "";
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #f43f5e;
      top: -2px;
      right: -1px;
      box-shadow: 0 0 0 2px #fff;
    }
    .title-row { display: flex; gap: 8px; align-items: center; margin-top: 4px; }
    .title { font-size: 26px; font-weight: 800; }
    .back-login {
      margin-left: auto;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      color: #1d4ed8;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }
    .back-login:hover { background: #dbeafe; }
    .badge { background: #dbeafe; color: #1d4ed8; padding: 3px 9px; border-radius: 10px; font-size: 12px; font-weight: 700; }
    .sub { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .chip-group {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      width: 100%;
      padding: 6px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: #e8edf4;
    }
    .chip {
      flex: 1;
      border: 1px solid transparent;
      background: transparent;
      color: #94a3b8;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .chip.active { background: #fff; color: #1e3a8a; border-color: var(--line); box-shadow: 0 2px 8px rgba(15,23,42,.08); }
    .userbox { margin-top: 8px; display: grid; gap: 4px; }
    .view-controls {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    .user-sub-row {
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .year-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex: 0 0 auto;
    }
    .year-inline span {
      font-size: 11px;
      color: #64748b;
      font-weight: 700;
      white-space: nowrap;
    }
    .year-inline select {
      border: 1px solid #dbe2ec;
      border-radius: 10px;
      background: #f8fafc;
      color: #334155;
      padding: 6px 8px;
      font-size: 12px;
      min-width: 98px;
    }
    .view-controls select {
      border: 1px solid #dbe2ec;
      border-radius: 10px;
      background: #f8fafc;
      color: #334155;
      padding: 8px;
      font-size: 12px;
    }
    .viewing {
      margin-top: 6px;
      font-size: 12px;
      color: #334155;
      font-weight: 700;
    }
    .selectors { margin-top: 10px; display: flex; gap: 8px; }
    select {
      flex: 1;
      border: 1px solid #dbe2ec;
      border-radius: 10px;
      background: #f8fafc;
      color: #334155;
      padding: 8px;
      font-size: 12px;
    }
    .section-nav {
      margin-top: 10px;
      background: #ffffff;
      border: 1px solid #e6ebf2;
      border-radius: 14px;
      padding: 8px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      position: sticky;
      top: 8px;
      z-index: 6;
      box-shadow: 0 4px 14px rgba(15,23,42,.06);
    }
    .section-nav::-webkit-scrollbar { height: 0; }
    .section-nav-label {
      flex: 0 0 auto;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      color: #1d4ed8;
      border-radius: 10px;
      padding: 5px 8px;
      line-height: 1.1;
      display: grid;
      gap: 2px;
      min-width: 78px;
      text-align: center;
      cursor: pointer;
    }
    .section-nav-label .t { font-size: 11px; font-weight: 800; }
    .section-nav-label .s { font-size: 10px; font-weight: 600; color: #64748b; }
    .nav-chip {
      border: 1px solid #dbe2ec;
      background: #f8fafc;
      color: #475569;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .nav-chip:hover { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }
    .section { margin-top: 12px; }
    .section[id] { scroll-margin-top: 84px; }
    .section h3 {
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 800;
      line-height: 1.2;
      color: #1e293b;
    }
    .section h3:before {
      content: "";
      width: 18px;
      height: 18px;
      display: inline-block;
      background-repeat: no-repeat;
      background-position: center;
      background-size: 18px 18px;
    }
    .section h3[data-icon="overview"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M2 12h12M3 10l3-3 2 2 4-5' fill='none' stroke='%233b82f6' stroke-width='1.8' stroke-linecap='round'/%3E%3C/svg%3E"); }
    .section h3[data-icon="map"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M8 14s4-3.8 4-7a4 4 0 1 0-8 0c0 3.2 4 7 4 7Z' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3Ccircle cx='8' cy='7' r='1.4' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3C/svg%3E"); }
    .section h3[data-icon="rank"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M2 13h12M4 11V7M8 11V4M12 11V6' fill='none' stroke='%233b82f6' stroke-width='1.8' stroke-linecap='round'/%3E%3C/svg%3E"); }
    .section h3[data-icon="stock"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M2 5h12M2 8h12M2 11h12' fill='none' stroke='%233b82f6' stroke-width='1.8'/%3E%3C/svg%3E"); }
    .section h3[data-icon="people"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='6' cy='5.3' r='2.1' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3Cpath d='M2.7 12.8a3.3 3.3 0 0 1 6.6 0M11.5 7.2a1.8 1.8 0 1 0 0-3.6' fill='none' stroke='%233b82f6' stroke-width='1.5'/%3E%3C/svg%3E"); }
    .section h3[data-icon="key"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='6.3' cy='6.5' r='2.7' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3Cpath d='m8.7 8.9 4.4 4.2' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3C/svg%3E"); }
    .section h3[data-icon="loss"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M2 4h12M5 4v9h6V4' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3Cpath d='m6.2 10.2 3.6-3.6M9.8 10.2 6.2 6.6' stroke='%23ef4444' stroke-width='1.6'/%3E%3C/svg%3E"); }
    .section h3[data-icon="risk"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M8 2.3 14 13H2L8 2.3Z' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3C/svg%3E"); }
    .section h3[data-icon="household"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M2.5 7.5 8 3l5.5 4.5v5.2H9.6v-3.1H6.4v3.1H2.5Z' fill='none' stroke='%233b82f6' stroke-width='1.5'/%3E%3C/svg%3E"); }
    .section h3[data-icon="target"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='4.8' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3Ccircle cx='8' cy='8' r='0.9' fill='%233b82f6'/%3E%3C/svg%3E"); }
    .section h3[data-icon="todo"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect x='3' y='2.8' width='10' height='10.4' rx='2' fill='none' stroke='%233b82f6' stroke-width='1.6'/%3E%3C/svg%3E"); }
    .section h3[data-icon="company"]:before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath d='M2.5 13h11M4 13V5.2h8V13' fill='none' stroke='%233b82f6' stroke-width='1.5'/%3E%3C/svg%3E"); }

    .panel {
      background: #fff;
      border: 1px solid #e6ebf2;
      border-radius: 22px;
      padding: 12px;
      box-shadow: 0 2px 12px rgba(15,23,42,.07);
    }
    .module-head { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eef2f7; padding-bottom: 8px; margin-bottom: 10px; }
    .module-title { font-size: 12px; color: var(--muted); font-weight: 700; }
    .module-link { font-size: 11px; color: var(--primary); font-weight: 700; }

    .cards { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
    .span-2 { grid-column: 1 / -1; }
    .card { background: #fff; border: 1px solid #e6ebf2; border-radius: 18px; padding: 12px; min-height: 88px; position: relative; }
    .card.clickable { cursor: pointer; }
    .label { font-size: 11px; color: var(--muted); }
    .value { font-size: 20px; font-weight: 700; margin-top: 4px; }
    .mini { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .num-value { font-size: inherit; line-height: 1; }
    .num-unit { font-size: .58em; margin-left: 2px; color: var(--muted); font-weight: 600; }
    b .num-unit { font-size: .62em; }
    .progress { margin-top: 6px; height: 7px; background: #e5e7eb; border-radius: 99px; overflow: hidden; }
    .progress > span {
      display: block;
      height: 100%;
      background: var(--primary);
      transform-origin: left center;
    }

    .overview-hero { background: linear-gradient(180deg,#fff 0%,#f8fbff 100%); border: 1px solid #dbe7ff; border-radius: 22px; padding: 14px; box-shadow: 0 8px 20px rgba(37,99,235,.08); }
    .hero-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .hero-grid { display: grid; grid-template-columns: 124px 1fr; gap: 12px; align-items: center; }
    .progress-ring { --p:75; width:112px; height:112px; border-radius:999px; background: conic-gradient(#3b82f6 calc(var(--p)*1%), #dbeafe 0); display:grid; place-items:center; position:relative; }
    .progress-ring:before { content:""; width:84px; height:84px; border-radius:999px; background:#fff; border:1px solid #e5edff; position:absolute; }
    .progress-ring > b { position:relative; z-index:1; font-size:24px; }
    .hero-stats { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    .stat { background:#f8fafc; border:1px solid #e5eaf2; border-radius:12px; padding:8px; }
    .stat.clickable { cursor: pointer; }
    .stat b { font-size:18px; }
    .stat.done b { color: var(--ok); }
    .stat.warn b { color: var(--primary); }
    .quick-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
    }
    .quick {
      border: 1px solid #e6ebf2;
      background: #ffffff;
      border-radius: 14px;
      padding: 8px;
      cursor: pointer;
    }
    .quick b { font-size: 18px; color: #0f172a; }
    .sketch-stack {
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }
    .gauge-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
    .gauge-card {
      border: 1px solid #dbe7ff;
      border-radius: 14px;
      background: #fff;
      padding: 8px 6px;
      display: grid;
      justify-items: center;
      gap: 4px;
    }
    .gauge-label {
      font-size: 11px;
      color: #64748b;
      font-weight: 700;
    }
    .mini-ring {
      --p: 80;
      width: 74px;
      height: 74px;
      border-radius: 999px;
      background: conic-gradient(#3b82f6 calc(var(--p) * 1%), #dbeafe 0);
      position: relative;
      display: grid;
      place-items: center;
    }
    .mini-ring::before {
      content: "";
      position: absolute;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #e5edff;
    }
    .mini-ring b {
      position: relative;
      z-index: 1;
      font-size: 15px;
      color: #0f172a;
    }
    .gauge-trend {
      font-size: 10px;
      color: #64748b;
      font-weight: 700;
      text-align: center;
      line-height: 1.35;
    }
    .sketch-block {
      position: relative;
      border: 1px solid #dbe7ff;
      border-radius: 14px;
      background: #fff;
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .sketch-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .sketch-title {
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
    }
    .sketch-body {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 8px;
      align-items: stretch;
    }
    .sketch-main {
      border: 1px solid #e8eef6;
      background: #f8fbff;
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 4px;
      align-content: center;
    }
    .sketch-main .main-value {
      font-size: 28px;
      font-weight: 800;
      color: #0f172a;
      line-height: 1.1;
    }
    .sketch-main .main-sub {
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
    }
    .sketch-main.warn .main-value {
      color: #c2410c;
    }
    .sketch-main.warn .main-sub {
      color: #64748b;
    }
    .sketch-lines {
      border: 1px solid #e8eef6;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
      display: grid;
      gap: 7px;
      align-content: center;
    }
    .sketch-line {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
    }
    .sketch-line .line-label {
      color: #64748b;
      font-weight: 700;
    }
    .sketch-line .line-value {
      color: #0f172a;
      font-weight: 800;
      cursor: pointer;
    }
    .sketch-line .line-rate {
      color: #475569;
      font-weight: 700;
      margin-left: 4px;
      font-size: 11px;
    }
    .sketch-line .line-only {
      color: #64748b;
      font-size: 11px;
      font-weight: 700;
    }
    .line-head {
      color: #64748b;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0;
    }
    .pct-highlight {
      color: #0ea5e9;
      font-weight: 800;
    }
    .pct-highlight.ok { color: #059669; }
    .pct-highlight.warn { color: #2563eb; }
    .sketch-line .line-value:hover { text-decoration: underline; text-decoration-color: #94a3b8; }
    .sketch-line .line-rate.ok { color: #059669; }
    .sketch-line .line-value.gap-alert {
      color: #c2410c;
    }
    .gap-num {
      color: #c2410c;
      font-weight: 800;
    }
    .sketch-main.warn .main-sub .num-value {
      color: #059669;
      font-weight: 800;
    }
    .fold-toggle {
      border: 0;
      background: #eff6ff;
      color: #1d4ed8;
      border-radius: 8px;
      width: 22px;
      height: 22px;
      line-height: 22px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      padding: 0;
    }
    .sketch-risk-note {
      font-size: 11px;
      border-radius: 10px;
      padding: 7px 8px;
      background: #f8fafc;
      color: #475569;
      border: 1px dashed #dbeafe;
    }
    .sketch-risk-note.warn {
      background: #fff7ed;
      color: #b45309;
      border-color: #fed7aa;
    }
    .overview-breakdown {
      margin-top: 10px;
      border-top: 1px dashed #dbe7ff;
      padding-top: 8px;
      display: grid;
      gap: 6px;
    }
    .break-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      border: 1px solid #e8eef6;
      background: #ffffff;
      border-radius: 10px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    .break-row .left { color: #64748b; font-weight: 700; }
    .break-row .right { color: #0f172a; font-weight: 800; }
    .break-tip {
      font-size: 11px;
      color: #475569;
      border-radius: 8px;
      padding: 5px 7px;
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
    }
    .break-tip.ok { color: #047857; border-color: #86efac; background: #ecfdf5; }
    .break-tip.warn { color: #b45309; border-color: #fcd34d; background: #fffbeb; }

    .area-rank-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .area-rank-sort {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 6px;
      margin-bottom: 8px;
    }
    .sort-chip {
      border: 1px solid #dbe2ec;
      background: #f8fafc;
      color: #64748b;
      border-radius: 999px;
      padding: 6px 4px;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
    }
    .sort-chip.active {
      border-color: #93c5fd;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .area-rank-item {
      border: 1px solid #e2e8f0;
      background: #fff;
      border-radius: 14px;
      padding: 9px 10px;
      margin-top: 8px;
    }
    .area-rank-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .area-rank-name { font-size: 14px; font-weight: 800; color: #0f172a; }
    .area-rank-rate {
      font-size: 13px;
      font-weight: 800;
      color: #059669;
      background: #ecfdf5;
      border: 1px solid #86efac;
      border-radius: 999px;
      padding: 2px 8px;
    }
    .area-rank-row {
      display: grid;
      grid-template-columns: 44px 1fr auto;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      margin-top: 4px;
    }
    .area-rank-k {
      color: #64748b;
      font-weight: 700;
    }
    .area-rank-v {
      color: #0f172a;
      font-weight: 700;
      cursor: pointer;
    }
    .area-rank-v:hover { text-decoration: underline; text-decoration-color: #94a3b8; }
    .area-rank-v .num-value { font-size: 14px; }
    .area-rank-pct { color: #2563eb; font-weight: 800; }
    .area-table-wrap {
      margin-top: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .area-table {
      width: 100%;
      min-width: 620px;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 11px;
    }
    .area-table th {
      text-align: left;
      color: #64748b;
      font-weight: 700;
      padding: 8px 8px;
      border-bottom: 1px solid #e2e8f0;
      background: #f8fafc;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .area-table td {
      vertical-align: top;
      padding: 8px 8px;
      border-bottom: 1px dashed #e2e8f0;
      background: #fff;
    }
    .area-unit {
      font-size: 13px;
      font-weight: 800;
      color: #0f172a;
    }
    .area-rank-no {
      font-size: 11px;
      color: #64748b;
      font-weight: 700;
      margin-bottom: 2px;
    }
    .area-rate-pill {
      display: inline-block;
      margin-top: 4px;
      font-size: 10px;
      font-weight: 800;
      color: #059669;
      background: #ecfdf5;
      border: 1px solid #86efac;
      border-radius: 999px;
      padding: 1px 6px;
    }
    .metric-cell {
      display: grid;
      gap: 3px;
    }
    .metric-line {
      color: #475569;
    }
    .metric-line .area-rank-v {
      margin-left: 2px;
    }
    .metric-rate {
      color: #2563eb;
      font-weight: 800;
    }

    .metric-row { display:flex; justify-content:space-between; align-items:center; gap:8px; border:1px solid #e8eef6; background:#f8fafc; border-radius:14px; padding:10px 12px; margin-top:8px; cursor:pointer; }
    .metric-row > div:last-child { display:flex; align-items:baseline; gap:4px; white-space:nowrap; flex-shrink:0; }
    .metric-row b { font-size:18px; color: var(--text); }
    .arrow { color:#94a3b8; font-size:20px; margin-left:8px; }
    .no-drill [data-drill] { pointer-events: none !important; cursor: default !important; }
    .no-drill .arrow { display: none !important; }
    .no-drill [data-drill].allow-drill { pointer-events: auto !important; cursor: pointer !important; }

    .pill-row { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px; margin-top:8px; }
    .pill { border:1px solid #dbe2ec; background:#f8fafc; border-radius:999px; padding:8px 10px; display:flex; justify-content:space-between; font-size:12px; cursor:pointer; }
    .pill.female { border-color:#f1dbc2; background:#fffaf4; }

    .house-grid { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:8px; margin-top:8px; }
    .house-card { border:1px solid #bfd5ff; background:#f8fbff; border-radius:10px; padding:8px; font-size:11px; cursor:pointer; }
    .house-card .value { font-size:16px; margin-top:4px; }

    .age-analysis { display:grid; gap:14px; margin-top:8px; }
    .age-item { cursor:pointer; }
    .age-head { display:grid; grid-template-columns:1fr auto; align-items:baseline; gap:8px; margin-bottom:6px; }
    .age-title { font-size:16px; font-weight:700; color:#334155; display:flex; align-items:baseline; gap:8px; }
    .age-share { font-size:12px; color: var(--muted); font-weight:700; }
    .age-stats { display:flex; align-items:baseline; gap:8px; }
    .age-total { font-size:18px; font-weight:800; color: var(--text); }
    .age-rate { font-size:12px; font-weight:700; color: var(--ok); white-space: nowrap; }
    .age-meta { display:flex; gap:18px; margin-top:6px; font-size:11px; color:#94a3b8; font-weight:700; }
    .age-meta .m:before,.age-meta .f:before{content:"";display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:-1px;}
    .age-meta .m:before{background:#60a5fa;} .age-meta .f:before{background:#fb7185;}
    .hh-grid { display:grid; gap:10px; margin-top:8px; }
    .hh-card { border:1px solid #dbe7ff; background:#f8fbff; border-radius:12px; padding:9px; }
    .hh-title-row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
    .hh-title { font-size:12px; font-weight:700; color:#334155; }
    .hh-top { display:flex; justify-content:space-between; align-items:baseline; gap:8px; }
    .hh-total { font-size:16px; font-weight:800; color:#0f172a; }
    .hh-bars { margin-top:6px; display:grid; gap:6px; }
    .hh-row { display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; }
    .hh-label { font-size:11px; color:#64748b; font-weight:700; }
    .hh-value { font-size:18px; color:#0f172a; font-weight:800; cursor:pointer; line-height:1; }
    .hh-value .num-value { font-size:1em; }
    .hh-value .num-unit { font-size:.62em; }
    .hh-value .pct-highlight { margin-left:4px; font-size:12px; font-weight:700; color:#0ea5e9; }
    .hh-track { height:7px; background:#e2e8f0; border-radius:999px; overflow:hidden; margin-top:3px; }
    .hh-fill { display:block; height:100%; background:#3b82f6; }
    .hh-fill { transform-origin: left center; }
    .hh-fill.ok { background:#10b981; }
    .hh-fill.warn { background:#f59e0b; }
    .hh-fill.slate { background:#64748b; }

    .key-desc-line { display:flex; flex-wrap:wrap; gap:6px; align-items:baseline; }
    .key-desc-line .name { font-size:14px; font-weight:700; color:#334155; }
    .key-desc-line .desc { font-size:12px; color:var(--muted); font-weight:600; }
    .key-stats { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; margin-top:6px; }
    .key-stat { border-radius:12px; border:1px solid #dbe2ec; background:#f8fafc; cursor:pointer; padding:7px 8px; min-height:50px; }
    .key-stat .t1 { font-size:11px; font-weight:700; }
    .key-stat .t2 { font-size:13px; font-weight:800; margin-top:3px; }
    .key-stat.insured { color:#047857; border-color:#86efac; background:linear-gradient(180deg,#f0fdf4 0%,#ecfdf5 100%); }
    .key-stat.uninsured { color:#b45309; border-color:#fcd34d; background:linear-gradient(180deg,#fffbeb 0%,#fef3c7 100%); }
    .key-total { font-size:11px; color:var(--muted); font-weight:700; margin-right:2px; }

    .risk-card { border:1px solid #fde68a; background:#fffbeb; border-radius:14px; padding:8px; margin-top:8px; cursor:pointer; }
    .risk-card.high { border-color:#fecaca; background:#fef2f2; }
    .risk-title { font-size:12px; font-weight:700; }
    .risk-desc { font-size:11px; color:var(--muted); margin-top:4px; }
    .staff-block { border:1px solid #e6ebf2; border-radius:14px; background:#f8fafc; padding:10px; }
    .staff-block + .staff-block { margin-top:10px; }
    .staff-subtitle { font-size:12px; color:var(--muted); font-weight:700; margin-bottom:8px; }
    .staff-grid { display:grid; gap:8px; }
    .staff-grid.two { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .staff-pies { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; margin-top:8px; }
    .staff-pie-card { border:1px solid #dbe2ec; border-radius:12px; background:#fff; padding:8px; }
    .staff-pie-title { font-size:11px; color:#64748b; font-weight:700; margin-bottom:6px; }
    .staff-pie {
      --seg: 50;
      --c1: #3b82f6;
      --c2: #10b981;
      width: 84px;
      height: 84px;
      border-radius: 999px;
      margin: 0 auto 8px;
      background: conic-gradient(var(--c1) calc(var(--seg) * 1%), var(--c2) 0);
      position: relative;
    }
    .staff-pie::before {
      content: "";
      position: absolute;
      inset: 14px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #e6ebf2;
    }
    .staff-pie-legend { display:grid; gap:4px; }
    .staff-pie-item { display:flex; justify-content:space-between; align-items:center; gap:6px; cursor:pointer; }
    .staff-pie-item .left { display:flex; align-items:center; gap:5px; }
    .dot { width:8px; height:8px; border-radius:999px; }
    .dot.c1 { background:#3b82f6; }
    .dot.c2 { background:#10b981; }
    .dot.c3 { background:#f59e0b; }
    .staff-pie-item .k { font-size:11px; color:#64748b; }
    .staff-pie-item .v { font-size:12px; font-weight:700; color:#0f172a; }
    .staff-chip {
      border:1px solid #dbe2ec;
      border-radius:12px;
      padding:8px;
      background:#fff;
      cursor:pointer;
    }
    .staff-chip .k { font-size:11px; color:#64748b; }
    .staff-chip .v { margin-top:4px; font-size:13px; font-weight:700; color:#0f172a; }
    .staff-chip .v .pct-highlight { margin-left:4px; }
    .pct-highlight.neg { color:#b45309; }
    .stock-group {
      border: 1px solid #dbe2ec;
      border-radius: 14px;
      background: #f8fafc;
      padding: 8px;
      margin-top: 8px;
    }
    .stock-group:first-of-type { margin-top: 0; }
    .stock-group-title {
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
      margin: 2px 2px 6px;
    }
    .flow-wrap { margin-top:8px; border-top:1px dashed #e2e8f0; padding-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
    .flow-item { border:1px solid #dbe2ec; background:#f8fafc; border-radius:999px; padding:4px 10px; font-size:12px; color:#475569; cursor:pointer; }
    .flow-num { font-size:16px; font-weight:800; margin:0 2px; color:#1d4ed8; }
    .flow-item.c1 .flow-num{color:#0f766e;} .flow-item.c2 .flow-num{color:#c2410c;} .flow-item.c3 .flow-num{color:#7c3aed;}
    .todo-card {
      border: 1px solid #dbe2ec;
      background: #f8fafc;
      border-radius: 12px;
      padding: 8px;
      margin-top: 8px;
    }
    .todo-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .todo-subgrid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }
    .todo-subgrid.three { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .todo-mini {
      border: 1px solid #e2e8f0;
      background: #ffffff;
      border-radius: 10px;
      padding: 6px 7px;
      cursor: pointer;
    }
    .todo-mini .k { font-size: 11px; color: #64748b; }
    .todo-mini .v { margin-top: 3px; font-size: 13px; font-weight: 700; color: #0f172a; }
    .progress:hover > span,
    .age-item:hover .progress > span,
    .hh-card:hover .hh-fill { animation: barGrow .65s ease-out both; }
    .progress-ring:hover,
    .mini-ring:hover,
    .staff-pie:hover { animation: piePop .45s ease-out both; }

    @keyframes barGrow {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }
    @keyframes piePop {
      from { opacity: .2; transform: scale(.86); }
      to { opacity: 1; transform: scale(1); }
    }

    .role-panels { display: none; }
    .role-panels.active { display: block; }

    .overlay { position:fixed; inset:0; background: rgba(15,23,42,.38); opacity:0; visibility:hidden; transition:.22s; z-index:10; }
    .overlay.show { opacity:1; visibility:visible; }
    .drawer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      max-width: min(480px, calc(100vw - 20px));
      margin: 0 auto;
      background: #f8fafc;
      border: 1px solid #e6ebf2;
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -10px 34px rgba(15,23,42,.16);
      transform: translateY(102%);
      transition: transform .22s ease;
      max-height: 78dvh;
      overflow: auto;
      padding: 12px;
      z-index: 20;
    }
    .drawer.show { transform: translateY(0); }
    .drawer-head { display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:#f8fafc; padding:2px 0 6px; z-index:1; }
    .drawer-head-right { display:flex; align-items:center; gap:6px; }
    .phone-toggle { font-size:11px; color:#475569; user-select:none; }
    .btn-mini { border:0; border-radius:8px; padding:4px 8px; font-size:11px; cursor:pointer; background:#e0f2fe; color:#0369a1; }
    .filters { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .filters input {
      border: 1px solid #dbe2ec;
      border-radius: 10px;
      background: #fff;
      color: #334155;
      padding: 8px;
      font-size: 12px;
      width: calc(33.333% - 6px);
      min-width: 140px;
    }
    .drawer-tools {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
      border-bottom:1px dashed #e2e8f0;
      padding-bottom:6px;
    }
    .drawer-result {
      font-size:12px;
      color:#64748b;
      font-weight:700;
      white-space:nowrap;
    }
    .drawer-tool-right {
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .cond-panel {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: min(300px, 84%);
      background: #ffffff;
      border-left: 1px solid #e2e8f0;
      box-shadow: -8px 0 24px rgba(15,23,42,.16);
      transform: translateX(105%);
      transition: transform .22s ease;
      z-index: 5;
      padding: 12px;
      overflow: auto;
    }
    .cond-panel.show { transform: translateX(0); }
    .cond-head { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
    .cond-actions { display:flex; gap:6px; }
    .cond-type {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px;
      background: #f8fafc;
      margin-bottom: 10px;
    }
    .cond-type select {
      width: 100%;
      border: 1px solid #dbe2ec;
      border-radius: 10px;
      background: #fff;
      color: #334155;
      padding: 8px;
      font-size: 12px;
    }
    .cond-groups { display:grid; gap:10px; }
    .cond-group {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px;
      background: #f8fafc;
    }
    .cond-group-title { font-size: 11px; color: #64748b; font-weight: 700; margin-bottom: 6px; }
    .cond-items { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px; }
    .cond-item { display:flex; align-items:center; gap:4px; font-size:11px; color:#334155; }
    .list-item { border:1px solid #e6ebf2; background:#fff; border-radius:14px; padding:10px; display:grid; grid-template-columns:1fr auto; gap:6px; margin-top:8px; font-size:12px; }
    .tags { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
    .tag { font-size:10px; border-radius:6px; padding:2px 6px; background:#f1f5f9; color:#0f172a; }
    .tag.warn { background:#fef3c7; color:#92400e; }
    .tag.danger { background:#fee2e2; color:#991b1b; }
    .tag.ok { background:#dcfce7; color:#166534; }
    .side-metric { text-align:right; display:flex; flex-direction:column; align-items:flex-end; justify-content:center; gap:4px; min-width:84px; }
    .side-metric .row { font-size:11px; color:var(--muted); }
    .side-metric .row .num-value { font-size:17px; color:var(--text); font-weight:800; }
    .side-label { font-size:11px; color:var(--muted); font-weight:600; margin-right:2px; }

    .bottom-nav { position: fixed; left:50%; transform:translateX(-50%); bottom:0; width:min(480px, calc(100vw - 20px)); background:rgba(248,250,252,.98); border-top:1px solid var(--line); border-radius:16px 16px 0 0; display:grid; grid-template-columns:repeat(4,1fr); padding:8px 10px 10px; z-index:8; }
    .nav-item { text-align:center; color:#94a3b8; font-size:11px; }
    .nav-item i { display:block; width:20px; height:20px; border-radius:6px; margin:0 auto 4px; background:#e2e8f0; }
    .nav-item.active { color:#2563eb; font-weight:700; }
    .nav-item.active i { background:#bfdbfe; }

    @media (max-width: 380px) {
      .hero-grid { grid-template-columns: 1fr; justify-items: center; }
      .hero-stats { width: 100%; }
      .title { font-size: 22px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="title-row">
        <div class="title" style="font-size:22px">全民参保数智动员手机看板</div>
        <button class="back-login" id="backLoginBtn">返回登录</button>
      </div>
      <div class="userbox">
        <div class="sub" id="userNameText">当前用户：-</div>
        <div class="user-sub-row">
          <div class="sub" id="unitText">所在单位：-</div>
          <div class="year-inline">
            <span>参保年度</span>
            <select id="yearSelect"></select>
          </div>
        </div>
      </div>
      <div class="view-controls" id="viewControls">
        <select id="levelSelect"></select>
        <select id="streetSelect"></select>
        <select id="villageSelect"></select>
      </div>
      <div class="viewing" id="viewingText">当前查看：-</div>
    </div>

    <div class="section-nav" id="leaderSectionNav">
      <div class="section-nav-label" id="navTopBtn"><span class="t">板块导航</span><span class="s">点击跳转</span></div>
      <button class="nav-chip" data-target="sec-overview">目标完成</button>
      <button class="nav-chip" data-target="sec-rank">区域排名</button>
      <button class="nav-chip" data-target="sec-stock">存量增量</button>
      <button class="nav-chip" data-target="sec-loss">减员分析</button>
      <button class="nav-chip" data-target="sec-household">户籍分析</button>
      <button class="nav-chip" data-target="sec-people">年龄性别</button>
      <button class="nav-chip" data-target="sec-key">重点对象</button>
      <button class="nav-chip" data-target="sec-staff">职工参保</button>
      <button class="nav-chip" data-target="sec-risk">风险监测</button>
    </div>

    <div id="leaderPanel" class="role-panels active">
      <div class="section" id="sec-overview"><h3 data-icon="overview">目标完成情况分析</h3><div class="cards" id="overviewCards"></div></div>
      <div class="section" id="sec-rank"><h3 data-icon="rank">区域参保情况排名</h3><div class="panel" id="mapPanel"></div></div>
      <div class="section" id="sec-stock"><h3 data-icon="stock">存量巩固与增量扩面</h3><div class="panel" id="stockPanel"></div></div>
      <div class="section" id="sec-loss"><h3 data-icon="loss">存量减员情况分析</h3><div class="panel" id="lossPanel"></div></div>
      <div class="section" id="sec-household"><h3 data-icon="household">户籍参保情况分析</h3><div class="panel" id="householdPanel"></div></div>
      <div class="section" id="sec-people"><h3 data-icon="people">性别年龄分布分析</h3><div class="panel" id="structurePanel"></div></div>
      <div class="section" id="sec-key"><h3 data-icon="key">重点对象参保分析</h3><div class="panel" id="keyPanel"></div></div>
      <div class="section" id="sec-staff"><h3 data-icon="company">职工参保情况分析</h3><div class="panel" id="staffPanel"></div></div>
      <div class="section" id="sec-risk"><h3 data-icon="risk">参保风险与异常监测</h3><div class="panel" id="riskPanel"></div></div>
    </div>

    <div id="workerPanel" class="role-panels">
      <div class="section"><h3 data-icon="target">我的目标与完成情况</h3><div class="cards" id="workerOverview"></div></div>
      <div class="section"><h3 data-icon="todo">待动员名单</h3><div class="panel" id="workerTodo"></div></div>
      <div class="section"><h3 data-icon="company">企业风险走访清单</h3><div class="panel" id="workerRisk"></div></div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active"><i></i>看板</div>
    <div class="nav-item"><i></i>分析</div>
    <div class="nav-item"><i></i>任务</div>
    <div class="nav-item"><i></i>我的</div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-head">
      <strong id="drawerTitle">明细名单</strong>
      <div class="drawer-head-right">
        <button class="btn-mini" id="drawerClose">关闭</button>
      </div>
    </div>
    <div class="filters">
      <input id="searchName" placeholder="姓名/企业名称（模糊）" />
      <input id="searchSecond" placeholder="联系电话/联系人（模糊）" />
      <input id="searchAddress" placeholder="地址（户籍/居住/企业地址，模糊）" />
    </div>
    <div class="drawer-tools">
      <div class="drawer-result" id="drawerResultText">当前筛选结果：0 条</div>
      <div class="drawer-tool-right">
        <label class="phone-toggle"><input type="checkbox" id="phoneToggle" /> 显示完整号码</label>
        <button class="btn-mini" id="conditionBtn">条件筛选</button>
      </div>
    </div>
    <div class="cond-panel" id="condPanel">
      <div class="cond-head">
        <b>条件筛选</b>
        <div class="cond-actions">
          <button class="btn-mini" id="condReset">重置</button>
          <button class="btn-mini" id="condApply">确定</button>
        </div>
      </div>
      <div class="cond-type">
        <div class="cond-group-title">对象类型</div>
        <select id="drawerType"></select>
      </div>
      <div class="cond-groups" id="condGroups"></div>
    </div>
    <div id="drawerList"></div>
  </div>

  <script>
    const STAFF_CONFIG = {
      // 职工参保人员细类口径（合计建议为 1）
      detailRatio: {
        onjob: 0.34,          // 在职职工
        orgRetired: 0.12,     // 单位退休人员
        flex1: 0.2,           // 灵活就业（一档）
        flex2: 0.14,          // 灵活就业（二档）
        personRetired1: 0.1,  // 个人退休（一档）
        personRetired2: 0.1   // 个人退休（二档）
      },
      // 单位参保口径（用于参加/未参加职工保单位数及环比）
      unitInsuredRate: 0.74,
      unitInsuredRateLastMonth: 0.71
    };

    function seededRand(seed) {
      const x = Math.sin(seed * 12.9898) * 43758.5453;
      return x - Math.floor(x);
    }

    function pickStaffDetail(seed) {
      const defs = [
        { key: "在职职工", big: "单位参保", w: STAFF_CONFIG.detailRatio.onjob },
        { key: "单位退休人员", big: "单位参保", w: STAFF_CONFIG.detailRatio.orgRetired },
        { key: "灵活就业（一档）", big: "个人参保", w: STAFF_CONFIG.detailRatio.flex1 },
        { key: "灵活就业（二档）", big: "个人参保", w: STAFF_CONFIG.detailRatio.flex2 },
        { key: "个人退休（一档）", big: "个人参保", w: STAFF_CONFIG.detailRatio.personRetired1 },
        { key: "个人退休（二档）", big: "个人参保", w: STAFF_CONFIG.detailRatio.personRetired2 }
      ];
      const total = defs.reduce((s, d) => s + Math.max(d.w || 0, 0), 0) || 1;
      let p = seededRand(seed);
      let acc = 0;
      for (const d of defs) {
        acc += (Math.max(d.w || 0, 0) / total);
        if (p <= acc) return d;
      }
      return defs[0];
    }

    const data = {
      district: "重庆市九龙坡区",
      streets: [
        { name: "杨家坪街道", villages: [mkVillage("天兴路社区", 1820, 1660), mkVillage("前进路社区", 1460, 1320), mkVillage("团结路社区", 1300, 1156)] },
        { name: "石桥铺街道", villages: [mkVillage("渝州路社区", 2100, 1908), mkVillage("高新区社区", 1740, 1586), mkVillage("科园一路社区", 980, 824)] },
        { name: "西彭镇", villages: [mkVillage("西彭社区", 2020, 1830), mkVillage("森迪村", 1210, 1038), mkVillage("铝城村", 1160, 948)] }
      ]
    };

    function mkVillage(name, target, current) {
      const uninsured = Math.max(target - current, 0);
      const residentPool = ["李明", "张华", "王芳", "赵刚", "周婷", "陈俊", "杨雪", "吴鹏", "刘洋", "黄敏", "何磊", "宋佳", "邓洁", "潘凯", "周文", "何杰"];
      const companyPool = ["宏达科技", "九龙物流", "渝新制造", "兴业商贸", "巴渝建工", "成信餐饮", "腾跃电子", "弘博服务", "云创医疗", "华腾教育"];
      const industries = ["制造", "物流", "建筑", "餐饮", "服务", "电子", "医疗", "教育"];
      const scales = ["小微", "中型", "大型"];
      const lossReasons = ["死亡", "辖区外参保", "停保", "转职工保（含灵活就业参保）"];
      const hukouStreet = ["杨家坪正街", "石桥铺渝州路", "西彭铝城大道", "九龙园区大道", "科园一路"];
      const liveStreet = ["天兴路", "前进路", "团结路", "渝州路", "高新区路", "科园一路"];

      const residents = Array.from({ length: Math.max(Math.floor(uninsured * 0.7), 24) }, (_, i) => {
        const age = (i * 4) % 76;
        const gender = i % 2 === 0 ? "男" : "女";
        const household = i % 3 === 0 ? "本区户籍" : "非本区户籍";
        let residenceDetail = "本辖区";
        if (household === "本区户籍") {
          const m = i % 20;
          residenceDetail = m < 8 ? "本辖区" : (m < 12 ? "区内其他辖区" : (m < 17 ? "市内外区" : "市外"));
        } else {
          const m = i % 20;
          residenceDetail = m < 7 ? "本辖区" : (m < 10 ? "区内其他辖区" : (m < 15 ? "市内外区" : "市外"));
        }
        const residence = residenceDetail === "本辖区" ? "本区居住" : "外区居住";
        const isPrimarySecondary = age >= 6 && age <= 18 && i % 2 === 0;
        const isCollege = age >= 16 && age <= 30 && i % 3 === 0;
        const isHardship = i % 7 === 0 || i % 11 === 0;
        const keyGroup = age <= 1 ? "新生儿" : (isPrimarySecondary ? "中小学生" : (isCollege ? "高校生" : (isHardship ? "资助对象" : "无")));
        const hardshipType = isHardship ? ["低保对象", "残疾对象", "特困对象"][i % 3] : "";
        const lastYearPaid = i % 5 !== 0;
        const lastYearLocalPaid = lastYearPaid && (i % 4 !== 0);
        const thisYearPaid = i % 6 !== 0;
        const thisYearType = thisYearPaid ? (i % 5 === 0 ? "职工保" : "居民保") : "未参保";
        let staffBigType = "";
        let staffDetailType = "";
        if (thisYearType === "职工保") {
          const d = pickStaffDetail((target + current + i + 1) * 17);
          staffBigType = d.big;
          staffDetailType = d.key;
        }
        let insuredPlace = "";
        if (thisYearPaid) {
          const p = (i * 7) % 10;
          insuredPlace = p < (household === "本区户籍" ? 6 : 4) ? "本区县参保" : (p < (household === "本区户籍" ? 8 : 7) ? "市内外区参保" : "市外参保");
        }
        let stockChangeType = "";
        let lossReason = "";
        if (lastYearLocalPaid) {
          const retained = thisYearPaid && thisYearType === "居民保" && insuredPlace === "本区县参保";
          if (retained) stockChangeType = "存量续保";
          else if (!thisYearPaid) stockChangeType = i % 3 === 0 ? "可动员" : (i % 2 === 0 ? "停保" : "死亡");
          else if (thisYearType === "职工保") stockChangeType = "转职工保（含灵活就业参保）";
          else stockChangeType = "辖区外参保";
          if (lossReasons.includes(stockChangeType)) lossReason = stockChangeType;
        }
        const pauseFlow = !thisYearPaid ? (i % 3 === 0 ? "转居民保" : (i % 3 === 1 ? "申请停保" : "跨区转出")) : "";
        const ageGroup = age <= 16 ? "16岁及以下" : age <= 30 ? "16-30岁" : age <= 45 ? "31-45岁" : age <= 60 ? "46-60岁" : "60岁以上";
        const phone = `13${(500000000 + i * 97).toString().slice(0, 9)}`;
        const hukouAddress = `重庆市九龙坡区${hukouStreet[i % hukouStreet.length]}${(i % 120) + 1}号`;
        const livingAddress = residenceDetail === "本辖区"
          ? `重庆市九龙坡区${name}${liveStreet[i % liveStreet.length]}${(i % 60) + 1}号`
          : (residenceDetail === "区内其他辖区"
            ? `重庆市九龙坡区其他辖区${(i % 90) + 1}号`
            : (residenceDetail === "市内外区"
              ? `重庆市主城其他区${(i % 130) + 1}号`
              : `重庆市外地区${(i % 220) + 1}号`));
        return {
          type: "居民",
          name: residentPool[i % residentPool.length] + (i + 1),
          reason: stockChangeType === "可动员" ? "存量未参保（可动员）" : (stockChangeType || (!thisYearPaid ? "未参保" : "已参保")),
          age, ageGroup, gender, household, residence, residenceDetail, insuredPlace,
          phone, hukouAddress, livingAddress,
          staffBigType, staffDetailType,
          hardshipType,
          isPrimarySecondary, isCollege, isHardship,
          keyGroup, lastYearPaid, lastYearLocalPaid, thisYearPaid, thisYearType, stockChangeType, lossReason, pauseFlow,
          duration: 1 + (i % 8),
          place: name
        };
      });

      const enterprises = Array.from({ length: Math.max(Math.floor(uninsured * 0.3), 8) }, (_, i) => {
        const risk = i % 3 === 0 ? "高" : (i % 3 === 1 ? "中" : "低");
        const rand1 = seededRand((target + i + 11) * 13);
        const rand2 = seededRand((current + i + 19) * 29);
        const staffInsured = rand1 < STAFF_CONFIG.unitInsuredRate;
        const lastMonthStaffInsured = rand2 < STAFF_CONFIG.unitInsuredRateLastMonth;
        return {
          type: "企业",
          name: companyPool[i % companyPool.length] + (i + 1),
          legalPerson: ["李强", "王磊", "张敏", "赵军", "陈涛"][i % 5],
          contactPerson: ["刘经理", "周主管", "黄主任", "何女士", "杨先生"][i % 5],
          phone: `18${(300000000 + i * 61).toString().slice(0, 9)}`,
          regAddress: `重庆市九龙坡区${name}${(i % 80) + 1}号`,
          reason: i % 2 === 0 ? "欠费超3个月" : "缴费基数做实率偏低",
          duration: 2 + (i % 10),
          gapRate: 8 + (i % 15),
          industry: industries[i % industries.length],
          scale: scales[i % scales.length],
          staffInsured,
          lastMonthStaffInsured,
          risk,
          place: name
        };
      });

      return { name, target, current, residents, enterprises };
    }

    const state = {
      identity: "district_leader",
      role: "leader",
      insuranceYear: new Date().getFullYear(),
      level: "district",
      street: data.streets[0].name,
      village: data.streets[0].villages[0].name,
      drawer: null,
      showFullPhone: false,
      areaRankSort: "total",
      areaRankExpanded: false,
      selectedTags: [],
      folds: {
        target: true,
        done: true,
        doneResident: false,
        gap: true,
        gapResident: false
      }
    };

    const els = {
      userNameText: document.getElementById("userNameText"),
      unitText: document.getElementById("unitText"),
      viewingText: document.getElementById("viewingText"),
      yearSelect: document.getElementById("yearSelect"),
      viewControls: document.getElementById("viewControls"),
      levelSelect: document.getElementById("levelSelect"),
      streetSelect: document.getElementById("streetSelect"),
      villageSelect: document.getElementById("villageSelect"),
      leaderSectionNav: document.getElementById("leaderSectionNav"),
      overviewCards: document.getElementById("overviewCards"),
      mapPanel: document.getElementById("mapPanel"),
      stockPanel: document.getElementById("stockPanel"),
      structurePanel: document.getElementById("structurePanel"),
      householdPanel: document.getElementById("householdPanel"),
      keyPanel: document.getElementById("keyPanel"),
      lossPanel: document.getElementById("lossPanel"),
      staffPanel: document.getElementById("staffPanel"),
      riskPanel: document.getElementById("riskPanel"),
      workerOverview: document.getElementById("workerOverview"),
      workerTodo: document.getElementById("workerTodo"),
      workerRisk: document.getElementById("workerRisk"),
      leaderPanel: document.getElementById("leaderPanel"),
      workerPanel: document.getElementById("workerPanel"),
      drawer: document.getElementById("drawer"),
      overlay: document.getElementById("overlay"),
      drawerTitle: document.getElementById("drawerTitle"),
      drawerType: document.getElementById("drawerType"),
      conditionBtn: document.getElementById("conditionBtn"),
      condPanel: document.getElementById("condPanel"),
      condGroups: document.getElementById("condGroups"),
      condApply: document.getElementById("condApply"),
      condReset: document.getElementById("condReset"),
      drawerResultText: document.getElementById("drawerResultText"),
      phoneToggle: document.getElementById("phoneToggle"),
      searchName: document.getElementById("searchName"),
      searchSecond: document.getElementById("searchSecond"),
      searchAddress: document.getElementById("searchAddress"),
      drawerList: document.getElementById("drawerList")
    };

    const identityProfiles = {
      district_leader: {
        label: "区医保局领导",
        userName: "焦主任",
        unit: "重庆市九龙坡区医保局",
        roles: ["leader"],
        levels: ["district", "street", "village"],
        street: null,
        village: null
      },
      street_leader: {
        label: "镇街社保所分管医保领导",
        userName: "李主任",
        unit: "石桥铺街道社保所",
        roles: ["leader"],
        levels: ["street", "village"],
        street: "石桥铺街道",
        village: null
      },
      village_leader: {
        label: "村居领导",
        userName: "张书记",
        unit: "渝州路社区居委会",
        roles: ["leader"],
        levels: ["village"],
        street: "石桥铺街道",
        village: "渝州路社区"
      },
      grid_worker: {
        label: "网格员",
        userName: "周网格员",
        unit: "渝州路社区第3网格",
        roles: ["worker"],
        levels: ["village"],
        street: "石桥铺街道",
        village: "渝州路社区"
      }
    };

    function currentProfile() { return identityProfiles[state.identity] || identityProfiles.district_leader; }

    function applyPermissionGuard() {
      const p = currentProfile();
      if (!p.roles.includes(state.role)) state.role = p.roles[0];
      if (!p.levels.includes(state.level)) state.level = p.levels[0];
      if (p.street) state.street = p.street;
      if (p.village) state.village = p.village;
      const st = getStreetObj(state.street);
      if (!st.villages.some(v => v.name === state.village)) state.village = st.villages[0].name;
    }

    function getStreetObj(name = state.street) { return data.streets.find(s => s.name === name) || data.streets[0]; }
    function sumNodes(nodes) { return nodes.reduce((a, n) => { a.target += n.target; a.current += n.current; a.residents.push(...n.residents); a.enterprises.push(...n.enterprises); return a; }, { target: 0, current: 0, residents: [], enterprises: [] }); }
    function aggregateStreet(street) { const b = sumNodes(street.villages); return { ...b, name: street.name }; }
    function aggregateDistrict() { const b = sumNodes(data.streets.flatMap(s => s.villages)); return { ...b, name: data.district }; }
    function currentNode() { if (state.level === "district") return aggregateDistrict(); if (state.level === "street") return aggregateStreet(getStreetObj()); const st = getStreetObj(); return st.villages.find(v => v.name === state.village) || st.villages[0]; }
    function ratio(a, b) { return b ? ((a / b) * 100).toFixed(1) : "0.0"; }
    function unitText(v, unit) { return `<span class="num-value">${Number(v || 0).toLocaleString()}</span><span class="num-unit">${unit}</span>`; }
    function computeCoreMetrics(node) {
      const done = node.current;
      const target = node.target;
      const pct = ratio(done, target);
      const staffTarget = Math.round(target * 0.42);
      const residentTarget = Math.max(target - staffTarget, 0);
      let staffDone = Math.min(staffTarget, Math.round(staffTarget * (Number(pct) / 100)));
      let residentDone = done - staffDone;
      if (residentDone > residentTarget) {
        residentDone = residentTarget;
        staffDone = done - residentDone;
      }
      if (staffDone > staffTarget) {
        staffDone = staffTarget;
        residentDone = done - staffDone;
      }
      if (residentDone < 0) {
        residentDone = 0;
        staffDone = done;
      }
      const gapStaff = staffTarget - staffDone;
      const gapResident = residentTarget - residentDone;
      const gapTotal = gapStaff + gapResident;
      return { done, target, pct, staffTarget, residentTarget, staffDone, residentDone, gapStaff, gapResident, gapTotal };
    }
    function residentDoneListByMetric(node) {
      const m = computeCoreMetrics(node);
      const pool = node.residents.filter(r => r.thisYearPaid).slice().sort((a, b) => (a.duration || 0) - (b.duration || 0));
      return pool.slice(0, Math.max(m.residentDone, 0));
    }

    function renderSelectors() {
      const p = currentProfile();
      const levelLabel = { district: "区级", street: "镇街", village: "村居" };
      const currentY = new Date().getFullYear();
      const years = [currentY, currentY - 1, currentY - 2, currentY - 3];
      if (!years.includes(Number(state.insuranceYear))) state.insuranceYear = currentY;
      els.yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}年度</option>`).join("");
      els.yearSelect.value = String(state.insuranceYear);
      els.levelSelect.innerHTML = p.levels.map(l => `<option value="${l}">${levelLabel[l]}</option>`).join("");
      els.levelSelect.value = state.level;

      const allowedStreets = p.street ? data.streets.filter(s => s.name === p.street) : data.streets;
      if (!allowedStreets.some(s => s.name === state.street)) state.street = allowedStreets[0].name;
      els.streetSelect.innerHTML = allowedStreets.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
      els.streetSelect.value = state.street;

      const st = getStreetObj(state.street);
      const allowedVillages = p.village ? st.villages.filter(v => v.name === p.village) : st.villages;
      if (!allowedVillages.some(v => v.name === state.village)) state.village = allowedVillages[0].name;
      els.villageSelect.innerHTML = allowedVillages.map(v => `<option value="${v.name}">${v.name}</option>`).join("");
      els.villageSelect.value = state.village;

      els.levelSelect.disabled = p.levels.length === 1;
      els.streetSelect.disabled = !!p.street;
      els.villageSelect.disabled = !!p.village;
      els.viewControls.style.display = p.roles.includes("leader") ? "grid" : "none";
      els.streetSelect.style.display = state.level === "district" ? "none" : "block";
      els.villageSelect.style.display = state.level === "village" ? "block" : "none";

      let viewing = "当前查看：";
      if (state.level === "district") viewing += `${data.district}（区级）`;
      if (state.level === "street") viewing += `${state.street}（镇街）`;
      if (state.level === "village") viewing += `${state.street} · ${state.village}（村居）`;
      viewing += ` · ${state.insuranceYear}年度`;
      els.viewingText.textContent = viewing;
      els.viewingText.style.display = p.roles.includes("leader") ? "block" : "none";
    }

    function renderOverview(node) {
      const metrics = computeCoreMetrics(node);
      const done = metrics.done, target = metrics.target, pct = metrics.pct;
      const yoy = ((done / Math.max(target, 1)) * 6).toFixed(1);
      const mom = ((done / Math.max(target, 1)) * 2.2).toFixed(1);
      const staffTarget = metrics.staffTarget;
      const residentTarget = metrics.residentTarget;
      const staffDone = metrics.staffDone;
      const residentDone = metrics.residentDone;
      const insuredResidents = Math.max(node.residents.filter(r => r.thisYearPaid).length, 1);
      const stockInsRaw = node.residents.filter(r => r.lastYearPaid && r.thisYearPaid).length;
      const residentStockDone = Math.round(residentDone * (stockInsRaw / insuredResidents));
      const residentIncrementDone = Math.max(residentDone - residentStockDone, 0);
      const gapStaff = metrics.gapStaff;
      const gapResident = metrics.gapResident;
      const gapTotal = metrics.gapTotal;
      const gapDecreaseDay = gapTotal === 0 ? 0 : Math.max(1, Math.round(gapTotal * 0.08));
      const mobilizeStock = node.residents.filter(r => r.lastYearPaid && !r.thisYearPaid).length;
      const mobilizeIncrement = node.residents.filter(r => !r.lastYearPaid && r.household === "本区户籍" && r.residence === "本区居住" && !r.thisYearPaid).length;
      const mobilizeTotal = mobilizeStock + mobilizeIncrement;
      const gapTip = mobilizeTotal >= gapResident
        ? `机会评估：可动员${unitText(mobilizeTotal, "人")}，高于居民保差距${unitText(gapResident, "人")}，任务仍有完成机会。`
        : `风险评估：可动员${unitText(mobilizeTotal, "人")}，低于居民保差距${unitText(gapResident, "人")}，任务完成存在风险。`;
      const staffDoneRate = ratio(staffDone, Math.max(staffTarget, 1));
      const residentDoneRate = ratio(residentDone, Math.max(residentTarget, 1));
      const staffTargetShare = ratio(staffTarget, Math.max(target, 1));
      const residentTargetShare = ratio(residentTarget, Math.max(target, 1));
      const staffGapShare = ratio(gapStaff, Math.max(staffTarget, 1));
      const residentGapShare = ratio(gapResident, Math.max(residentTarget, 1));
      const totalYoy = yoy;
      const totalMom = mom;
      const staffYoy = (Number(staffDoneRate) * 0.05).toFixed(1);
      const staffMom = (Number(staffDoneRate) * 0.02).toFixed(1);
      const residentYoy = (Number(residentDoneRate) * 0.05).toFixed(1);
      const residentMom = (Number(residentDoneRate) * 0.02).toFixed(1);

      els.overviewCards.innerHTML = `
        <div class="overview-hero span-2 no-drill">
          <div class="hero-top">
            <div class="label">核心指标概览</div>
            <div class="mini">完成率仪表盘（同比/环比）</div>
          </div>
          <div class="gauge-row">
            <div class="gauge-card clickable" data-drill="progress">
              <div class="gauge-label">总完成率</div>
              <div class="mini-ring" style="--p:${Math.min(Number(pct), 100)}"><b class="pct-highlight warn">${pct}%</b></div>
              <div class="gauge-trend">同比 <span class="pct-highlight warn">+${totalYoy}%</span> · 环比 <span class="pct-highlight warn">+${totalMom}%</span></div>
            </div>
            <div class="gauge-card clickable" data-drill="staff_done">
              <div class="gauge-label">职工保完成率</div>
              <div class="mini-ring" style="--p:${Math.min(Number(staffDoneRate), 100)}"><b class="pct-highlight ok">${staffDoneRate}%</b></div>
              <div class="gauge-trend">同比 <span class="pct-highlight ok">+${staffYoy}%</span> · 环比 <span class="pct-highlight ok">+${staffMom}%</span></div>
            </div>
            <div class="gauge-card clickable" data-drill="resident_done">
              <div class="gauge-label">居民保完成率</div>
              <div class="mini-ring" style="--p:${Math.min(Number(residentDoneRate), 100)}"><b class="pct-highlight">${residentDoneRate}%</b></div>
              <div class="gauge-trend">同比 <span class="pct-highlight">+${residentYoy}%</span> · 环比 <span class="pct-highlight">+${residentMom}%</span></div>
            </div>
          </div>
          <div class="sketch-stack">
            <div class="sketch-block">
              <div class="sketch-head">
                <div class="sketch-title">参保目标总人数</div>
              </div>
              <div class="sketch-body">
                <div class="sketch-main clickable" data-drill="target_all">
                  <div class="main-value">${unitText(target, "人")}</div>
                  <div class="main-sub">占比 100%</div>
                </div>
                <div class="sketch-lines">
                  <div class="sketch-line">
                    <span class="line-only">其中：</span>
                    <span class="line-head">占比</span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">职工保</span>
                    <span class="line-value" data-drill="target_staff">${unitText(staffTarget, "人")} <span class="line-rate pct-highlight warn">${staffTargetShare}%</span></span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">居民保</span>
                    <span class="line-value" data-drill="target_resident">${unitText(residentTarget, "人")} <span class="line-rate pct-highlight">${residentTargetShare}%</span></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="sketch-block">
              <div class="sketch-head">
                <div class="sketch-title">已完成参保人数</div>
              </div>
              <div class="sketch-body">
                <div class="sketch-main clickable allow-drill" data-drill="done_all">
                  <div class="main-value">${unitText(done, "人")}</div>
                  <div class="main-sub">完成率 ${pct}%</div>
                </div>
                <div class="sketch-lines">
                  <div class="sketch-line">
                    <span class="line-only">其中：</span>
                    <span class="line-head">完成率</span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">职工保</span>
                    <span class="line-value allow-drill" data-drill="staff_done">${unitText(staffDone, "人")} <span class="line-rate pct-highlight ok">${staffDoneRate}%</span></span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">居民保</span>
                    <span class="line-value allow-drill" data-drill="resident_done">${unitText(residentDone, "人")} <span class="line-rate pct-highlight ok">${residentDoneRate}%</span></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="sketch-block">
              <div class="sketch-head">
                <div class="sketch-title">目标差距</div>
              </div>
              <div class="sketch-body">
                <div class="sketch-main clickable warn" data-drill="need_mobilize">
                  <div class="main-value">${unitText(gapTotal, "人")}</div>
                  <div class="main-sub">较昨日减少 ${unitText(gapDecreaseDay, "人")}</div>
                </div>
                <div class="sketch-lines">
                  <div class="sketch-line">
                    <span class="line-only">其中：</span>
                    <span class="line-head">差距率</span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">职工保</span>
                    <span class="line-value gap-alert" data-drill="gap_staff">${unitText(gapStaff, "人")} <span class="line-rate pct-highlight warn">${staffGapShare}%</span></span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">居民保</span>
                    <span class="line-value gap-alert" data-drill="gap_resident">${unitText(gapResident, "人")} <span class="line-rate pct-highlight warn">${residentGapShare}%</span></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="sketch-block">
              <div class="sketch-head">
                <div class="sketch-title">居民保可动员人数</div>
              </div>
              <div class="sketch-body">
                <div class="sketch-main clickable allow-drill" data-drill="mobilize_total">
                  <div class="main-value">${unitText(mobilizeTotal, "人")}</div>
                  <div class="main-sub">与居民保差距联动评估</div>
                </div>
                <div class="sketch-lines">
                  <div class="sketch-line">
                    <span class="line-only">其中：</span>
                    <span></span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">存量可动员</span>
                    <span class="line-value allow-drill" data-drill="mobilize_stock">${unitText(mobilizeStock, "人")}</span>
                  </div>
                  <div class="sketch-line">
                    <span class="line-label">增量可动员</span>
                    <span class="line-value allow-drill" data-drill="mobilize_increment">${unitText(mobilizeIncrement, "人")}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="sketch-risk-note ${mobilizeTotal >= gapResident ? "" : "warn"}">${gapTip}</div>
          </div>
        </div>`;
      // 核心指标概览默认不穿透，仅“已完成参保人数”3个数值支持穿透
      els.overviewCards.querySelectorAll("[data-drill].allow-drill").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderMap() {
      let childNodes = [];
      if (state.level === "district") childNodes = data.streets.map(s => aggregateStreet(s));
      else if (state.level === "street") childNodes = getStreetObj().villages;
      else {
        els.mapPanel.innerHTML = `<div class="module-head"><span class="module-title">区域参保情况排名</span><span class="module-link">村居无下级</span></div><div class="mini">村居层级无下级单位，可切换到镇街/区级查看下级排名。</div>`;
        return;
      }

      const metricOf = (n) => {
        const totalTarget = n.target;
        const totalDone = n.current;
        const totalRate = Number(ratio(totalDone, Math.max(totalTarget, 1)));
        const staffTarget = Math.round(totalTarget * 0.42);
        const residentTarget = Math.max(totalTarget - staffTarget, 0);
        let staffDone = Math.min(staffTarget, Math.round(staffTarget * (totalRate / 100)));
        let residentDone = totalDone - staffDone;
        if (residentDone > residentTarget) {
          residentDone = residentTarget;
          staffDone = totalDone - residentDone;
        }
        if (residentDone < 0) residentDone = 0;
        const staffRate = Number(ratio(staffDone, Math.max(staffTarget, 1)));
        const residentRate = Number(ratio(residentDone, Math.max(residentTarget, 1)));
        return { name: n.name, totalTarget, totalDone, totalRate, staffTarget, staffDone, staffRate, residentTarget, residentDone, residentRate };
      };

      let list = childNodes.map(metricOf);
      const sortField = state.areaRankSort === "staff" ? "staffRate" : (state.areaRankSort === "resident" ? "residentRate" : "totalRate");
      list.sort((a, b) => b[sortField] - a[sortField]);
      const visible = state.areaRankExpanded ? list : list.slice(0, 3);
      const levelLabel = state.level === "district" ? "镇街" : "村居";
      const sortLabel = state.areaRankSort === "staff" ? "职工保完成率" : (state.areaRankSort === "resident" ? "居民保完成率" : "总参保任务完成率");

      const row = (name, metric, key, unitName, allowDrill = false) =>
        `<span class="area-rank-v ${allowDrill ? "allow-drill" : ""}" data-drill="area|${unitName}|${key}">${unitText(metric, "人")}</span>`;

      const renderStaffCell = (x) => `
        <td>
            <div class="metric-cell">
            <div class="metric-line">任务${row("职工任务", x.staffTarget, "target_staff", x.name)}</div>
            <div class="metric-line">完成${row("职工完成", x.staffDone, "staff_done", x.name, true)}</div>
            <div class="metric-rate">完成率 ${x.staffRate.toFixed(1)}%</div>
          </div>
        </td>`;
      const renderResidentCell = (x) => `
        <td>
            <div class="metric-cell">
            <div class="metric-line">任务${row("居民任务", x.residentTarget, "target_resident", x.name)}</div>
            <div class="metric-line">完成${row("居民完成", x.residentDone, "resident_done", x.name, true)}</div>
            <div class="metric-rate">完成率 ${x.residentRate.toFixed(1)}%</div>
          </div>
        </td>`;
      const renderTotalCell = (x) => `
        <td>
            <div class="metric-cell">
            <div class="metric-line">任务${row("总任务", x.totalTarget, "target_all", x.name)}</div>
            <div class="metric-line">完成${row("总完成", x.totalDone, "done_all", x.name, true)}</div>
            <div class="metric-rate">完成率 ${x.totalRate.toFixed(1)}%</div>
          </div>
        </td>`;
      const metricOrder = state.areaRankSort === "staff"
        ? ["staff", "total", "resident"]
        : (state.areaRankSort === "resident" ? ["resident", "total", "staff"] : ["total", "staff", "resident"]);
      const metricLabel = { total: "总参保", staff: "职工保", resident: "居民保" };
      const renderMetricCell = (key, x) => (key === "total" ? renderTotalCell(x) : (key === "staff" ? renderStaffCell(x) : renderResidentCell(x)));

      els.mapPanel.innerHTML = `
        <div class="area-rank-head">
          <div class="module-title">下级${levelLabel}参保完成情况排名</div>
          <button class="btn-mini" id="areaExpandBtn">${state.areaRankExpanded ? "收起" : "展开全部"}</button>
        </div>
        <div class="area-rank-sort">
          <button class="sort-chip ${state.areaRankSort === "total" ? "active" : ""}" data-sort="total">按总完成率</button>
          <button class="sort-chip ${state.areaRankSort === "staff" ? "active" : ""}" data-sort="staff">按职工保完成率</button>
          <button class="sort-chip ${state.areaRankSort === "resident" ? "active" : ""}" data-sort="resident">按居民保完成率</button>
        </div>
        <div class="mini">当前排序：${sortLabel} · 默认展示前3名</div>
        <div class="area-table-wrap no-drill">
          <table class="area-table">
            <thead>
              <tr>
                <th>排名 / 单位</th>
                <th>${metricLabel[metricOrder[0]]}</th>
                <th>${metricLabel[metricOrder[1]]}</th>
                <th>${metricLabel[metricOrder[2]]}</th>
              </tr>
            </thead>
            <tbody>
              ${visible.map((x, i) => `
              <tr>
                <td>
                  <div class="area-rank-no">第 ${i + 1} 名</div>
                  <div class="area-unit">${x.name}</div>
                  <span class="area-rate-pill">${x[sortField].toFixed(1)}%</span>
                </td>
                ${renderMetricCell(metricOrder[0], x)}
                ${renderMetricCell(metricOrder[1], x)}
                ${renderMetricCell(metricOrder[2], x)}
              </tr>`).join("")}
            </tbody>
          </table>
        </div>
      `;
      els.mapPanel.querySelectorAll("[data-sort]").forEach(el => el.onclick = () => { state.areaRankSort = el.dataset.sort; render(); });
      const expBtn = document.getElementById("areaExpandBtn");
      if (expBtn) expBtn.onclick = () => { state.areaRankExpanded = !state.areaRankExpanded; render(); };
      // 区域参保情况排名仅“完成人数”支持穿透
      els.mapPanel.querySelectorAll("[data-drill].allow-drill").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderStock(node) {
      const residents = node.residents;
      const stockTotal = residents.filter(r => r.lastYearLocalPaid).length;
      const stockInsured = residents.filter(r => r.lastYearLocalPaid && r.stockChangeType === "存量续保").length;
      const retained = stockInsured;
      const loss = residents.filter(r => r.lastYearLocalPaid && ["死亡", "辖区外参保", "停保", "转职工保（含灵活就业参保）"].includes(r.stockChangeType)).length;
      const movableStockUnpaid = residents.filter(r => r.lastYearLocalPaid && r.stockChangeType === "可动员").length;
      const newPay = residents.filter(r => ((!r.lastYearPaid) || (r.lastYearPaid && !r.lastYearLocalPaid)) && r.thisYearPaid && r.insuredPlace === "本区县参保").length;
      const possibleInc = residents.filter(r => r.household === "本区户籍" && !r.thisYearPaid && ( (!r.lastYearPaid) || (r.lastYearPaid && !r.lastYearLocalPaid) )).length;
      els.stockPanel.innerHTML = `
        <div class="module-head"><span class="module-title">存量与增量双线跟踪（居民保）</span><span class="module-link">点击穿透</span></div>
        <div class="stock-group">
          <div class="stock-group-title">存量情况分析</div>
          <div class="metric-row" data-drill="stock_total"><div><div class="label">存量总数</div><div class="mini">去年在本辖区参保基数</div></div><div><b>${unitText(stockTotal, "人")}</b><span class="arrow">›</span></div></div>
          <div class="metric-row" data-drill="stock_insured"><div><div class="label">存量已参保（存量巩固/续保）</div><div class="mini">占比 <span class="pct-highlight">${ratio(stockInsured, Math.max(stockTotal, 1))}%</span></div></div><div><b>${unitText(stockInsured, "人")}</b><span class="arrow">›</span></div></div>
          <div class="metric-row" data-drill="stock_uninsured"><div><div class="label">存量未参保（可动员）</div><div class="mini">去年存量到现在还没参保，可继续动员</div></div><div><b>${unitText(movableStockUnpaid, "人")}</b><span class="arrow">›</span></div></div>
          <div class="metric-row" data-drill="stock_loss"><div><div class="label">存量减员（已确认）</div><div class="mini">死亡/辖区外参保/停保/转职工保（含灵活就业参保）</div></div><div><b><span class="gap-num">${unitText(loss, "人")}</span></b><span class="arrow">›</span></div></div>
        </div>
        <div class="stock-group">
          <div class="stock-group-title">增量情况分析</div>
          <div class="metric-row" data-drill="increment_new"><div><div class="label">新增参保（扩面）</div><div class="mini">去年未参保或在辖区外参保，今年在辖区内参保</div></div><div><b><span class="pct-highlight ok">${unitText(newPay, "人")}</span></b><span class="arrow">›</span></div></div>
          <div class="metric-row" data-drill="increment_potential"><div><div class="label">可扩增量（优先）</div><div class="mini">去年未参保或在辖区外参保，今年尚未参保的本区户籍不论是否居住本区</div></div><div><b>${unitText(possibleInc, "人")}</b><span class="arrow">›</span></div></div>
        </div>`;
      els.stockPanel.querySelectorAll(".metric-row").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderStructure(node) {
      const total = node.residents.length;
      const male = node.residents.filter(r => r.gender === "男").length;
      const female = total - male;
      const ageGroups = [
        { label: "16岁及以下", list: node.residents.filter(r => r.ageGroup === "16岁及以下") },
        { label: "16-30岁", list: node.residents.filter(r => r.ageGroup === "16-30岁") },
        { label: "31-45岁", list: node.residents.filter(r => r.ageGroup === "31-45岁") },
        { label: "46-60岁", list: node.residents.filter(r => r.ageGroup === "46-60岁") },
        { label: "60岁以上", list: node.residents.filter(r => r.ageGroup === "60岁以上") }
      ];
      const ageDetail = ageGroups.map((a, i) => {
        const m = a.list.filter(r => r.gender === "男").length;
        const f = a.list.length - m;
        const insured = a.list.filter(r => r.thisYearPaid).length;
        return { label: a.label, count: a.list.length, m, f, insureRate: ratio(insured, Math.max(a.list.length, 1)), share: ratio(a.list.length, Math.max(total, 1)), color: i === 1 ? "#3b82f6" : "#10b981" };
      });

      els.structurePanel.innerHTML = `
        <div class="module-head"><span class="module-title">年龄与性别分析</span><span class="module-link">维度穿透</span></div>
        <div class="mini">性别结构</div>
        <div class="pill-row">
          <div class="pill clickable" data-drill="gender_male"><span>男</span><b>${ratio(male, total)}% · ${unitText(male, "人")}</b></div>
          <div class="pill female clickable" data-drill="gender_female"><span>女</span><b>${ratio(female, total)}% · ${unitText(female, "人")}</b></div>
        </div>
        <div class="mini" style="margin-top:10px">年龄分析（总人数、占比、参保率）</div>
        <div class="age-analysis">
          ${ageDetail.map(a => `
            <div class="age-item clickable" data-drill="age_${a.label}">
              <div class="age-head">
                <div class="age-title">${a.label}<span class="age-share">占总人数 ${a.share}%</span></div>
                <div class="age-stats"><div class="age-total">${unitText(a.count, "人")}</div><div class="age-rate">${a.insureRate}% 参保率</div></div>
              </div>
              <div class="progress"><span style="width:${a.share}%;background:${a.color}"></span></div>
              <div class="age-meta"><div class="m">男: ${unitText(a.m, "人")}</div><div class="f">女: ${unitText(a.f, "人")}</div></div>
            </div>`).join("")}
        </div>`;
      els.structurePanel.querySelectorAll(".clickable").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderHousehold(node) {
      const rs = node.residents;
      const local = rs.filter(r => r.household === "本区户籍");
      const localIns = local.filter(r => r.thisYearPaid);
      const localUn = local.filter(r => !r.thisYearPaid);
      const nonlocalLive = rs.filter(r => r.household === "非本区户籍" && r.residenceDetail === "本辖区");
      const nonlocalLiveIns = nonlocalLive.filter(r => r.thisYearPaid);
      const nonlocalLiveUn = nonlocalLive.filter(r => !r.thisYearPaid);
      const v = (n, t) => `<span class="hh-value" data-drill="${n.key}">${unitText(n.count, "人")} <span class="pct-highlight">${ratio(n.count, Math.max(t, 1))}%</span></span>`;
      const bar = (count, total, cls = "") => `<div class="hh-track"><span class="hh-fill ${cls}" style="width:${ratio(count, Math.max(total, 1))}%"></span></div>`;

      const dim2 = [
        { key: "hh_local_insured_local", label: "本区县参保", count: localIns.filter(r => r.insuredPlace === "本区县参保").length, cls: "ok" },
        { key: "hh_local_insured_city_other", label: "市内外区参保", count: localIns.filter(r => r.insuredPlace === "市内外区参保").length, cls: "" },
        { key: "hh_local_insured_outcity", label: "市外参保", count: localIns.filter(r => r.insuredPlace === "市外参保").length, cls: "warn" }
      ];
      const dim3 = [
        { key: "hh_local_uninsured_res_local", label: "居住本辖区", count: localUn.filter(r => r.residenceDetail === "本辖区").length, cls: "ok" },
        { key: "hh_local_uninsured_res_district_other", label: "居住区内其他辖区", count: localUn.filter(r => r.residenceDetail === "区内其他辖区").length, cls: "" },
        { key: "hh_local_uninsured_res_city_other", label: "居住市内外区", count: localUn.filter(r => r.residenceDetail === "市内外区").length, cls: "warn" },
        { key: "hh_local_uninsured_res_outcity", label: "居住市外", count: localUn.filter(r => r.residenceDetail === "市外").length, cls: "slate" }
      ];

      els.householdPanel.innerHTML = `
        <div class="module-head"><span class="module-title">户籍参保结构四维分析</span><span class="module-link">数字可穿透</span></div>
        <div class="hh-grid">
          <div class="hh-card">
            <div class="hh-title-row">
              <div class="hh-title">1. 辖区户籍总人口</div>
              <span class="hh-value" data-drill="hh_local_total">${unitText(local.length, "人")}</span>
            </div>
            <div class="hh-bars">
              <div><div class="hh-row"><span class="hh-label">已参保</span>${v({ key: "hh_local_insured", count: localIns.length }, local.length)}</div>${bar(localIns.length, local.length, "ok")}</div>
              <div><div class="hh-row"><span class="hh-label">未参保</span>${v({ key: "hh_local_uninsured", count: localUn.length }, local.length)}</div>${bar(localUn.length, local.length, "warn")}</div>
            </div>
          </div>

          <div class="hh-card">
            <div class="hh-title-row">
              <div class="hh-title">2. 已参保户籍人口去向</div>
              <span class="hh-value" data-drill="hh_local_insured">${unitText(localIns.length, "人")}</span>
            </div>
            <div class="hh-bars">${dim2.map(x => `<div><div class="hh-row"><span class="hh-label">${x.label}</span>${v({ key: x.key, count: x.count }, localIns.length)}</div>${bar(x.count, localIns.length, x.cls)}</div>`).join("")}</div>
          </div>

          <div class="hh-card">
            <div class="hh-title-row">
              <div class="hh-title">3. 未参保户籍人口居住分布</div>
              <span class="hh-value" data-drill="hh_local_uninsured">${unitText(localUn.length, "人")}</span>
            </div>
            <div class="hh-bars">${dim3.map(x => `<div><div class="hh-row"><span class="hh-label">${x.label}</span>${v({ key: x.key, count: x.count }, localUn.length)}</div>${bar(x.count, localUn.length, x.cls)}</div>`).join("")}</div>
          </div>

          <div class="hh-card">
            <div class="hh-title-row">
              <div class="hh-title">4. 辖区非户籍居住总人口</div>
              <span class="hh-value" data-drill="hh_nonlocal_live_total">${unitText(nonlocalLive.length, "人")}</span>
            </div>
            <div class="hh-bars">
              <div><div class="hh-row"><span class="hh-label">已参保</span>${v({ key: "hh_nonlocal_live_insured", count: nonlocalLiveIns.length }, nonlocalLive.length)}</div>${bar(nonlocalLiveIns.length, nonlocalLive.length, "ok")}</div>
              <div><div class="hh-row"><span class="hh-label">未参保</span>${v({ key: "hh_nonlocal_live_uninsured", count: nonlocalLiveUn.length }, nonlocalLive.length)}</div>${bar(nonlocalLiveUn.length, nonlocalLive.length, "warn")}</div>
            </div>
          </div>
        </div>`;
      els.householdPanel.querySelectorAll("[data-drill]").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderKey(node) {
      const groups = [
        { key: "新生儿", label: "新生儿", desc: "当年出生0~1岁", list: node.residents.filter(r => r.age >= 0 && r.age <= 1) },
        { key: "中小学生", label: "中小学生", desc: "6~18岁在校中小学生", list: node.residents.filter(r => r.age >= 6 && r.age <= 18 && r.isPrimarySecondary) },
        { key: "高校生", label: "高校生", desc: "16~30岁在校高校生（含大中专）", list: node.residents.filter(r => r.age >= 16 && r.age <= 30 && r.isCollege) },
        { key: "资助对象", label: "资助对象", desc: "低保户、残疾等困难居民", list: node.residents.filter(r => r.isHardship) }
      ].map(g => {
        const total = g.list.length;
        const insured = g.list.filter(r => r.thisYearPaid).length;
        const uninsured = total - insured;
        return { ...g, total, insured, uninsured, insuredRate: ratio(insured, Math.max(total, 1)), uninsuredRate: ratio(uninsured, Math.max(total, 1)) };
      });

      els.keyPanel.innerHTML = `<div class="module-head"><span class="module-title">重点人群分布</span><span class="module-link">按类型穿透</span></div>` + groups.map(g => `
        <div class="metric-row" data-drill="key_${g.key}">
          <div>
            <div class="key-desc-line"><span class="name">${g.label}</span><span class="desc">- ${g.desc}</span></div>
            <div class="key-stats">
              <span class="key-stat insured" data-drill="key_insured_${g.key}"><div class="t1">已参保</div><div class="t2">${unitText(g.insured, "人")} · 占比 ${g.insuredRate}%</div></span>
              <span class="key-stat uninsured" data-drill="key_uninsured_${g.key}"><div class="t1">未参保</div><div class="t2">${unitText(g.uninsured, "人")} · 占比 ${g.uninsuredRate}%</div></span>
            </div>
          </div>
          <div><span class="key-total">总人数</span><b>${unitText(g.total, "人")}</b><span class="arrow">›</span></div>
        </div>`).join("");
      els.keyPanel.querySelectorAll(".metric-row").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
      els.keyPanel.querySelectorAll(".key-stat").forEach(el => el.onclick = (e) => { e.stopPropagation(); openDrawer(el.dataset.drill); });
    }

    function renderLoss(node) {
      const loss = node.residents.filter(r => r.lastYearLocalPaid && ["死亡", "辖区外参保", "停保", "转职工保（含灵活就业参保）"].includes(r.stockChangeType));
      const reasons = ["死亡", "辖区外参保", "停保", "转职工保（含灵活就业参保）"];
      els.lossPanel.innerHTML = `<div class="module-head"><span class="module-title">居民保存量减员原因拆解</span><span class="module-link">原因追踪</span></div>` + reasons.map(r => `<div class="metric-row" data-drill="loss_${r}"><div><div class="label">${r}</div><div class="mini">存量减员原因</div></div><div><b>${unitText(loss.filter(x => x.lossReason === r).length, "人")}</b><span class="arrow">›</span></div></div>`).join("");
      els.lossPanel.querySelectorAll(".metric-row").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderRisk(node) {
      const high = node.enterprises.filter(e => e.risk === "高").length;
      const medium = node.enterprises.filter(e => e.risk === "中").length;
      const flow1 = node.residents.filter(r => r.pauseFlow === "转居民保").length;
      const flow2 = node.residents.filter(r => r.pauseFlow === "申请停保").length;
      const flow3 = node.residents.filter(r => r.pauseFlow === "跨区转出").length;
      els.riskPanel.innerHTML = `
        <div class="module-head"><span class="module-title">风险预警任务</span><span class="module-link">企业穿透</span></div>
        <div class="risk-card high" data-drill="risk_high"><div class="risk-title">高风险 ${unitText(high, "家")} 企业</div><div class="risk-desc">欠费/断缴超3个月、参保差异率≥20%、缴费基数做实率<80%</div></div>
        <div class="risk-card" data-drill="risk_medium"><div class="risk-title">中风险 ${unitText(medium, "家")} 企业</div><div class="risk-desc">参保登记未缴费、欠费3个月内、灵活就业近30天未缴</div></div>
        <div class="flow-wrap">
          <div class="flow-item c1" data-drill="flow_resident">转居民保 <span class="flow-num">${flow1}</span> 人</div>
          <div class="flow-item c2" data-drill="flow_pause">申请停保 <span class="flow-num">${flow2}</span> 人</div>
          <div class="flow-item c3" data-drill="flow_transfer">跨区转出 <span class="flow-num">${flow3}</span> 人</div>
        </div>`;
      els.riskPanel.querySelectorAll("[data-drill]").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderStaff(node) {
      const target = node.target;
      const done = node.current;
      const pct = ratio(done, target);
      const staffTarget = Math.round(target * 0.42);
      let staffDone = Math.min(staffTarget, Math.round(staffTarget * (Number(pct) / 100)));
      let residentDone = done - staffDone;
      const residentTarget = Math.max(target - staffTarget, 0);
      if (residentDone > residentTarget) {
        residentDone = residentTarget;
        staffDone = done - residentDone;
      }
      if (staffDone > staffTarget) {
        staffDone = staffTarget;
        residentDone = done - staffDone;
      }
      if (residentDone < 0) {
        residentDone = 0;
        staffDone = done;
      }

      const detailDefs = [
        { key: "在职职工", big: "单位参保", mode: "staff_detail_onjob" },
        { key: "单位退休人员", big: "单位参保", mode: "staff_detail_org_retired" },
        { key: "灵活就业（一档）", big: "个人参保", mode: "staff_detail_flex_1" },
        { key: "灵活就业（二档）", big: "个人参保", mode: "staff_detail_flex_2" },
        { key: "个人退休（一档）", big: "个人参保", mode: "staff_detail_person_retired_1" },
        { key: "个人退休（二档）", big: "个人参保", mode: "staff_detail_person_retired_2" }
      ];
      const totalStaffPeople = staffDone;
      const weights = detailDefs.map(d => {
        if (d.key === "在职职工") return STAFF_CONFIG.detailRatio.onjob || 0;
        if (d.key === "单位退休人员") return STAFF_CONFIG.detailRatio.orgRetired || 0;
        if (d.key === "灵活就业（一档）") return STAFF_CONFIG.detailRatio.flex1 || 0;
        if (d.key === "灵活就业（二档）") return STAFF_CONFIG.detailRatio.flex2 || 0;
        if (d.key === "个人退休（一档）") return STAFF_CONFIG.detailRatio.personRetired1 || 0;
        if (d.key === "个人退休（二档）") return STAFF_CONFIG.detailRatio.personRetired2 || 0;
        return 0;
      });
      const wSum = weights.reduce((s, w) => s + w, 0) || 1;
      const baseCounts = weights.map(w => Math.floor(totalStaffPeople * (w / wSum)));
      let remain = Math.max(totalStaffPeople - baseCounts.reduce((s, c) => s + c, 0), 0);
      let idx = 0;
      while (remain > 0) {
        baseCounts[idx % baseCounts.length] += 1;
        idx += 1;
        remain -= 1;
      }
      const detailStats = detailDefs.map((d, i) => ({ ...d, count: baseCounts[i] || 0 }));
      const onJobCount = detailStats.find(d => d.key === "在职职工")?.count || 0;
      const orgRetiredCount = detailStats.find(d => d.key === "单位退休人员")?.count || 0;
      const byBig = {
        unit: onJobCount + orgRetiredCount,
        personal: Math.max(totalStaffPeople - onJobCount - orgRetiredCount, 0)
      };

      const unitsTotal = node.enterprises.length;
      const unitsInsured = node.enterprises.filter(e => e.staffInsured).length;
      const unitsUninsured = Math.max(unitsTotal - unitsInsured, 0);
      const unitsInsuredLastMonth = node.enterprises.filter(e => e.lastMonthStaffInsured).length;
      const unitsUninsuredLastMonth = Math.max(unitsTotal - unitsInsuredLastMonth, 0);
      const mom = (cur, prev) => `${cur >= prev ? "+" : ""}${(prev ? ((cur - prev) * 100 / prev) : 0).toFixed(1)}%`;
      const momCls = (cur, prev) => (cur - prev) < 0 ? "pct-highlight neg" : "pct-highlight";
      const byBigSplit = Number(ratio(byBig.unit, Math.max(totalStaffPeople, 1)));
      const unitSubTotal = Math.max(onJobCount + orgRetiredCount, 1);
      const unitSubSplit = Number(ratio(onJobCount, unitSubTotal));

      els.staffPanel.innerHTML = `
        <div class="module-head"><span class="module-title">职工参保人员与参保单位双维分析</span><span class="module-link">数字可穿透</span></div>
        <div class="staff-block">
          <div class="staff-subtitle">1. 参保职工分布（大类+细类）</div>
          <div class="metric-row" data-drill="staff_people_all"><div><div class="label">职工参保总人数</div></div><div><b>${unitText(totalStaffPeople, "人")}</b><span class="arrow">›</span></div></div>
          <div class="staff-pies">
            <div class="staff-pie-card">
              <div class="staff-pie-title">单位参保 vs 个人参保（灵活就业）</div>
              <div class="staff-pie" style="--seg:${byBigSplit};--c1:#3b82f6;--c2:#10b981;"></div>
              <div class="staff-pie-legend">
                <div class="staff-pie-item" data-drill="staff_big_unit"><span class="left"><span class="dot c1"></span><span class="k">单位参保</span></span><span class="v">${unitText(byBig.unit, "人")} <span class="pct-highlight">${ratio(byBig.unit, Math.max(totalStaffPeople, 1))}%</span></span></div>
                <div class="staff-pie-item" data-drill="staff_big_personal"><span class="left"><span class="dot c2"></span><span class="k">个人参保</span></span><span class="v">${unitText(byBig.personal, "人")} <span class="pct-highlight">${ratio(byBig.personal, Math.max(totalStaffPeople, 1))}%</span></span></div>
              </div>
            </div>
            <div class="staff-pie-card">
              <div class="staff-pie-title">单位参保内部：在职 vs 单位退休</div>
              <div class="staff-pie" style="--seg:${unitSubSplit};--c1:#2563eb;--c2:#f59e0b;"></div>
              <div class="staff-pie-legend">
                <div class="staff-pie-item" data-drill="staff_detail_onjob"><span class="left"><span class="dot c1"></span><span class="k">在职职工</span></span><span class="v">${unitText(onJobCount, "人")} <span class="pct-highlight">${ratio(onJobCount, unitSubTotal)}%</span></span></div>
                <div class="staff-pie-item" data-drill="staff_detail_org_retired"><span class="left"><span class="dot c3"></span><span class="k">单位退休人员</span></span><span class="v">${unitText(orgRetiredCount, "人")} <span class="pct-highlight">${ratio(orgRetiredCount, unitSubTotal)}%</span></span></div>
              </div>
            </div>
          </div>
          <div class="staff-grid two" style="margin-top:8px">
            ${detailStats.filter(d => !["在职职工", "单位退休人员"].includes(d.key)).map(d => `<div class="staff-chip" data-drill="${d.mode}"><div class="k">${d.big} · ${d.key}</div><div class="v">${unitText(d.count, "人")} <span class="pct-highlight">${ratio(d.count, Math.max(totalStaffPeople, 1))}%</span></div></div>`).join("")}
          </div>
        </div>
        <div class="staff-block">
          <div class="staff-subtitle">2. 参保单位分布</div>
          <div class="metric-row" data-drill="staff_unit_total"><div><div class="label">全辖区单位总数</div></div><div><b>${unitText(unitsTotal, "家")}</b><span class="arrow">›</span></div></div>
          <div class="staff-grid two" style="margin-top:8px">
            <div class="staff-chip" data-drill="staff_unit_insured">
              <div class="k">参加职工保单位</div>
              <div class="v">${unitText(unitsInsured, "家")} <span class="pct-highlight">${ratio(unitsInsured, Math.max(unitsTotal, 1))}%</span> <span class="${momCls(unitsInsured, unitsInsuredLastMonth)}">环比 ${mom(unitsInsured, unitsInsuredLastMonth)}</span></div>
            </div>
            <div class="staff-chip" data-drill="staff_unit_uninsured">
              <div class="k">未参加职工保单位</div>
              <div class="v">${unitText(unitsUninsured, "家")} <span class="pct-highlight warn">${ratio(unitsUninsured, Math.max(unitsTotal, 1))}%</span> <span class="${momCls(unitsUninsured, unitsUninsuredLastMonth)}">环比 ${mom(unitsUninsured, unitsUninsuredLastMonth)}</span></div>
            </div>
          </div>
        </div>`;
      els.staffPanel.querySelectorAll("[data-drill]").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function renderWorker(node) {
      const metrics = computeCoreMetrics(node);
      const residentTarget = metrics.residentTarget;
      const residentDone = metrics.residentDone;
      const diff = metrics.gapResident;
      const pct = ratio(residentDone, residentTarget);
      const yesterdayAdded = Math.max(0, Math.round(residentDone * 0.012));
      const updateAt = new Date().toLocaleString("zh-CN", { hour12: false });

      const stockUnpaidList = node.residents.filter(r => r.lastYearLocalPaid && r.stockChangeType === "可动员");
      const incrementPotentialList = node.residents.filter(r =>
        !r.thisYearPaid &&
        ((!r.lastYearPaid) || (r.lastYearPaid && !r.lastYearLocalPaid)) &&
        (r.household === "本区户籍" || r.residence === "本区居住")
      );
      const mobilizableCount = stockUnpaidList.length + incrementPotentialList.length;
      const workerWarn = mobilizableCount < diff;

      const byRel = (list) => {
        const a = list.filter(r => r.household === "本区户籍" && r.residence === "本区居住").length;
        const b = list.filter(r => r.household === "本区户籍" && r.residence !== "本区居住").length;
        const c = list.filter(r => r.household !== "本区户籍" && r.residence === "本区居住").length;
        const d = list.filter(r => r.household !== "本区户籍" && r.residence !== "本区居住").length;
        return { a, b, c, d };
      };
      const stockRel = byRel(stockUnpaidList);
      const incRel = byRel(incrementPotentialList);

      const hardshipPending = node.residents.filter(r =>
        r.isHardship && !r.thisYearPaid &&
        ((r.lastYearLocalPaid && r.stockChangeType === "可动员") || (((!r.lastYearPaid) || (r.lastYearPaid && !r.lastYearLocalPaid)) && (r.household === "本区户籍" || r.residence === "本区居住")))
      );
      const hardshipTypeList = ["低保对象", "残疾对象", "特困对象"].map(t => ({
        type: t,
        count: hardshipPending.filter(r => r.hardshipType === t).length
      }));

      els.workerOverview.innerHTML = `
        <div class="module-head span-2"><span class="module-title">村居任务概览</span><span class="module-link">今日更新 ${updateAt}</span></div>
        <div class="card"><div class="label">本村居目标（居民保）</div><div class="value">${unitText(residentTarget, "人")}</div></div>
        <div class="card clickable" data-drill="worker_done_resident">
          <div class="label">已参保（居民保）</div>
          <div class="value" style="display:flex;justify-content:space-between;align-items:baseline;gap:8px;">
            <span>${unitText(residentDone, "人")}</span>
            <span class="mini" style="margin:0;white-space:nowrap;">昨日新增 <span class="pct-highlight ok" style="font-size:13px;">${unitText(yesterdayAdded, "人")}</span></span>
          </div>
        </div>
        <div class="card"><div class="label">目标差距（居民保）</div><div class="value">${unitText(diff, "人")}</div></div>
        <div class="card"><div class="label">完成进度</div><div class="value"><span class="pct-highlight ok">${pct}%</span></div><div class="progress"><span style="width:${Math.min(Number(pct),100)}%"></span></div></div>`;
      els.workerOverview.querySelectorAll(".clickable").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));

      els.workerTodo.innerHTML = `
        <div class="module-head"><span class="module-title">待动员名单</span><span class="module-link">优先级排序</span></div>
        <div class="metric-row" data-drill="worker_mobilizable"><div><div class="label">可动员人数</div><div class="mini">存量未参保 + 可增量动员</div></div><div><b>${unitText(mobilizableCount, "人")}</b><span class="arrow">›</span></div></div>
        ${workerWarn ? `<div class="sketch-risk-note warn">预警提醒：可动员${unitText(mobilizableCount, "人")}，低于目标差距${unitText(diff, "人")}，任务完成存在风险。</div>` : ""}

        <div class="todo-card">
          <div class="todo-head metric-row" data-drill="worker_stock_unpaid" style="margin-top:0;border:0;background:transparent;padding:0">
            <div><div class="label">存量未参保（可动员）</div></div>
            <div><b>${unitText(stockUnpaidList.length, "人")}</b><span class="arrow">›</span></div>
          </div>
          <div class="todo-subgrid">
            <div class="todo-mini" data-drill="stock_hh_local_res_local"><div class="k">户在人在</div><div class="v">${unitText(stockRel.a, "人")} · <span class="pct-highlight">${ratio(stockRel.a, Math.max(stockUnpaidList.length,1))}%</span></div></div>
            <div class="todo-mini" data-drill="stock_hh_local_res_other"><div class="k">户在人不在</div><div class="v">${unitText(stockRel.b, "人")} · <span class="pct-highlight">${ratio(stockRel.b, Math.max(stockUnpaidList.length,1))}%</span></div></div>
            <div class="todo-mini" data-drill="stock_hh_other_res_local"><div class="k">人在户不在</div><div class="v">${unitText(stockRel.c, "人")} · <span class="pct-highlight">${ratio(stockRel.c, Math.max(stockUnpaidList.length,1))}%</span></div></div>
            <div class="todo-mini" data-drill="stock_hh_other_res_other"><div class="k">人户均不在</div><div class="v">${unitText(stockRel.d, "人")} · <span class="pct-highlight">${ratio(stockRel.d, Math.max(stockUnpaidList.length,1))}%</span></div></div>
          </div>
        </div>

        <div class="todo-card">
          <div class="todo-head metric-row" data-drill="worker_increment_potential" style="margin-top:0;border:0;background:transparent;padding:0">
            <div><div class="label">可扩增量人员</div></div>
            <div><b>${unitText(incrementPotentialList.length, "人")}</b><span class="arrow">›</span></div>
          </div>
          <div class="todo-subgrid three">
            <div class="todo-mini" data-drill="inc_hh_local_res_local"><div class="k">户在人在</div><div class="v">${unitText(incRel.a, "人")} · <span class="pct-highlight">${ratio(incRel.a, Math.max(incrementPotentialList.length,1))}%</span></div></div>
            <div class="todo-mini" data-drill="inc_hh_local_res_other"><div class="k">户在人不在</div><div class="v">${unitText(incRel.b, "人")} · <span class="pct-highlight">${ratio(incRel.b, Math.max(incrementPotentialList.length,1))}%</span></div></div>
            <div class="todo-mini" data-drill="inc_hh_other_res_local"><div class="k">人在户不在</div><div class="v">${unitText(incRel.c, "人")} · <span class="pct-highlight">${ratio(incRel.c, Math.max(incrementPotentialList.length,1))}%</span></div></div>
          </div>
        </div>

        <div class="todo-card">
          <div class="todo-head metric-row" data-drill="hardship_pending_total" style="margin-top:0;border:0;background:transparent;padding:0">
            <div><div class="label">重点资助对象（待动员）</div><div class="mini">与存量未参保、可扩增量交叉</div></div>
            <div><b>${unitText(hardshipPending.length, "人")}</b><span class="arrow">›</span></div>
          </div>
          <div class="todo-subgrid three">
            ${hardshipTypeList.map(x => `<div class="todo-mini" data-drill="hardship_type_${x.type}"><div class="k">${x.type}</div><div class="v">${unitText(x.count, "人")} · <span class="pct-highlight">${ratio(x.count, Math.max(hardshipPending.length,1))}%</span></div></div>`).join("")}
          </div>
        </div>`;
      els.workerTodo.querySelectorAll("[data-drill]").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));

      const highRisk = node.enterprises.filter(e => e.risk === "高").length;
      const mediumRisk = node.enterprises.filter(e => e.risk === "中").length;
      els.workerRisk.innerHTML = `
        <div class="module-head"><span class="module-title">风险预警任务</span><span class="module-link">企业穿透</span></div>
        <div class="risk-card high" data-drill="risk_high"><div class="risk-title">高风险 ${unitText(highRisk, "家")} 企业</div><div class="risk-desc">欠费/断缴超3个月、参保差异率≥20%、缴费基数做实率<80%</div></div>
        <div class="risk-card" data-drill="risk_medium"><div class="risk-title">中风险 ${unitText(mediumRisk, "家")} 企业</div><div class="risk-desc">参保登记未缴费、欠费3个月内、灵活就业近30天未缴</div></div>`;
      els.workerRisk.querySelectorAll("[data-drill]").forEach(el => el.onclick = () => openDrawer(el.dataset.drill));
    }

    function getDrawerItems(mode) {
      if (mode && mode.startsWith("area|")) {
        const parts = mode.split("|");
        const unitName = parts[1];
        const baseMode = parts[2];
        let unitNode = null;
        if (state.level === "district") {
          const s = data.streets.find(x => x.name === unitName);
          if (s) unitNode = aggregateStreet(s);
        } else if (state.level === "street") {
          const v = getStreetObj().villages.find(x => x.name === unitName);
          if (v) unitNode = v;
        }
        if (!unitNode) return [];
        const residents = unitNode.residents;
        const enterprises = unitNode.enterprises;
        const all = [...residents, ...enterprises];
        const localFilters = {
          target_all: x => x.type === "居民",
          target_staff: x => x.type === "企业",
          target_resident: x => x.type === "居民",
          done_all: x => x.type === "居民" && x.thisYearPaid,
          staff_done: x => x.type === "企业",
          resident_done: x => x.type === "居民" && x.thisYearPaid
        };
        return localFilters[baseMode] ? all.filter(localFilters[baseMode]) : all;
      }
      const n = currentNode();
      const residents = n.residents;
      const enterprises = n.enterprises;
      const all = [...residents, ...enterprises];
      if (mode === "resident_done" || mode === "worker_done_resident") return residentDoneListByMetric(n);
      const filters = {
        target_all: x => x.type === "居民",
        target_staff: x => x.type === "企业",
        target_resident: x => x.type === "居民",
        done_all: x => x.type === "居民" && x.thisYearPaid,
        staff_done: x => x.type === "企业",
        resident_done: x => x.type === "居民" && x.thisYearPaid,
        staff_people_all: x => x.type === "居民" && x.thisYearType === "职工保",
        staff_big_unit: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffBigType === "单位参保",
        staff_big_personal: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffBigType === "个人参保",
        staff_detail_onjob: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffDetailType === "在职职工",
        staff_detail_org_retired: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffDetailType === "单位退休人员",
        staff_detail_flex_1: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffDetailType === "灵活就业（一档）",
        staff_detail_flex_2: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffDetailType === "灵活就业（二档）",
        staff_detail_person_retired_1: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffDetailType === "个人退休（一档）",
        staff_detail_person_retired_2: x => x.type === "居民" && x.thisYearType === "职工保" && x.staffDetailType === "个人退休（二档）",
        staff_unit_total: x => x.type === "企业",
        staff_unit_insured: x => x.type === "企业" && x.staffInsured,
        staff_unit_uninsured: x => x.type === "企业" && !x.staffInsured,
        worker_done_resident: x => x.type === "居民" && x.thisYearPaid,
        worker_stock_unpaid: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "可动员",
        worker_increment_potential: x => x.type === "居民" && !x.thisYearPaid && ((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && (x.household === "本区户籍" || x.residence === "本区居住"),
        worker_mobilizable: x => x.type === "居民" && (
          (x.lastYearLocalPaid && x.stockChangeType === "可动员") ||
          (!x.thisYearPaid && ((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && (x.household === "本区户籍" || x.residence === "本区居住"))
        ),
        stock_hh_local_res_local: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "可动员" && x.household === "本区户籍" && x.residence === "本区居住",
        stock_hh_local_res_other: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "可动员" && x.household === "本区户籍" && x.residence !== "本区居住",
        stock_hh_other_res_local: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "可动员" && x.household !== "本区户籍" && x.residence === "本区居住",
        stock_hh_other_res_other: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "可动员" && x.household !== "本区户籍" && x.residence !== "本区居住",
        inc_hh_local_res_local: x => x.type === "居民" && !x.thisYearPaid && ((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && x.household === "本区户籍" && x.residence === "本区居住",
        inc_hh_local_res_other: x => x.type === "居民" && !x.thisYearPaid && ((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && x.household === "本区户籍" && x.residence !== "本区居住",
        inc_hh_other_res_local: x => x.type === "居民" && !x.thisYearPaid && ((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && x.household !== "本区户籍" && x.residence === "本区居住",
        hardship_pending_total: x => x.type === "居民" && x.isHardship && !x.thisYearPaid && (
          (x.lastYearLocalPaid && x.stockChangeType === "可动员") ||
          (((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && (x.household === "本区户籍" || x.residence === "本区居住"))
        ),
        hardship_type_低保对象: x => x.type === "居民" && x.isHardship && x.hardshipType === "低保对象" && !x.thisYearPaid && (
          (x.lastYearLocalPaid && x.stockChangeType === "可动员") ||
          (((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && (x.household === "本区户籍" || x.residence === "本区居住"))
        ),
        hardship_type_残疾对象: x => x.type === "居民" && x.isHardship && x.hardshipType === "残疾对象" && !x.thisYearPaid && (
          (x.lastYearLocalPaid && x.stockChangeType === "可动员") ||
          (((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && (x.household === "本区户籍" || x.residence === "本区居住"))
        ),
        hardship_type_特困对象: x => x.type === "居民" && x.isHardship && x.hardshipType === "特困对象" && !x.thisYearPaid && (
          (x.lastYearLocalPaid && x.stockChangeType === "可动员") ||
          (((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && (x.household === "本区户籍" || x.residence === "本区居住"))
        ),
        resident_stock_done: x => x.type === "居民" && x.lastYearPaid && x.thisYearPaid,
        resident_increment_done: x => x.type === "居民" && !x.lastYearPaid && x.thisYearPaid,
        gap_staff: x => x.type === "企业" && x.risk !== "低",
        gap_resident: x => x.type === "居民" && !x.thisYearPaid,
        mobilize_total: x => x.type === "居民" && !x.thisYearPaid && (x.lastYearPaid || (x.household === "本区户籍" && x.residence === "本区居住")),
        mobilize_stock: x => x.type === "居民" && x.lastYearPaid && !x.thisYearPaid,
        mobilize_increment: x => x.type === "居民" && !x.lastYearPaid && x.household === "本区户籍" && x.residence === "本区居住" && !x.thisYearPaid,
        need_mobilize: x => x.type === "居民" ? !x.thisYearPaid : x.risk !== "低",
        progress: x => x.type === "居民",
        stock_total: x => x.type === "居民" && x.lastYearLocalPaid,
        stock_insured: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "存量续保",
        stock_retained: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "存量续保",
        stock_loss: x => x.type === "居民" && x.lastYearLocalPaid && ["死亡", "辖区外参保", "停保", "转职工保（含灵活就业参保）"].includes(x.stockChangeType),
        stock_unpaid: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "可动员",
        stock_uninsured: x => x.type === "居民" && x.lastYearLocalPaid && x.stockChangeType === "可动员",
        increment_new: x => x.type === "居民" && ((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)) && x.thisYearPaid && x.insuredPlace === "本区县参保",
        increment_potential: x => x.type === "居民" && x.household === "本区户籍" && !x.thisYearPaid && ((!x.lastYearPaid) || (x.lastYearPaid && !x.lastYearLocalPaid)),
        gender_male: x => x.type === "居民" && x.gender === "男",
        gender_female: x => x.type === "居民" && x.gender === "女",
        local_local: x => x.type === "居民" && x.household === "本区户籍" && x.residence === "本区居住",
        local_other: x => x.type === "居民" && x.household === "本区户籍" && x.residence === "外区居住",
        nonlocal_local: x => x.type === "居民" && x.household === "非本区户籍" && x.residence === "本区居住",
        hh_local_total: x => x.type === "居民" && x.household === "本区户籍",
        hh_local_insured: x => x.type === "居民" && x.household === "本区户籍" && x.thisYearPaid,
        hh_local_uninsured: x => x.type === "居民" && x.household === "本区户籍" && !x.thisYearPaid,
        hh_local_insured_local: x => x.type === "居民" && x.household === "本区户籍" && x.thisYearPaid && x.insuredPlace === "本区县参保",
        hh_local_insured_city_other: x => x.type === "居民" && x.household === "本区户籍" && x.thisYearPaid && x.insuredPlace === "市内外区参保",
        hh_local_insured_outcity: x => x.type === "居民" && x.household === "本区户籍" && x.thisYearPaid && x.insuredPlace === "市外参保",
        hh_local_uninsured_res_local: x => x.type === "居民" && x.household === "本区户籍" && !x.thisYearPaid && x.residenceDetail === "本辖区",
        hh_local_uninsured_res_district_other: x => x.type === "居民" && x.household === "本区户籍" && !x.thisYearPaid && x.residenceDetail === "区内其他辖区",
        hh_local_uninsured_res_city_other: x => x.type === "居民" && x.household === "本区户籍" && !x.thisYearPaid && x.residenceDetail === "市内外区",
        hh_local_uninsured_res_outcity: x => x.type === "居民" && x.household === "本区户籍" && !x.thisYearPaid && x.residenceDetail === "市外",
        hh_nonlocal_live_total: x => x.type === "居民" && x.household === "非本区户籍" && x.residenceDetail === "本辖区",
        hh_nonlocal_live_insured: x => x.type === "居民" && x.household === "非本区户籍" && x.residenceDetail === "本辖区" && x.thisYearPaid,
        hh_nonlocal_live_uninsured: x => x.type === "居民" && x.household === "非本区户籍" && x.residenceDetail === "本辖区" && !x.thisYearPaid,
        risk_high: x => x.type === "企业" && x.risk === "高",
        risk_medium: x => x.type === "企业" && x.risk === "中",
        flow_resident: x => x.type === "居民" && x.pauseFlow === "转居民保",
        flow_pause: x => x.type === "居民" && x.pauseFlow === "申请停保",
        flow_transfer: x => x.type === "居民" && x.pauseFlow === "跨区转出"
      };
      if (mode && mode.startsWith("age_")) return residents.filter(r => r.ageGroup === mode.replace("age_", ""));
      if (mode && mode.startsWith("key_insured_")) { const g = mode.replace("key_insured_", ""); return residents.filter(r => r.keyGroup === g && r.thisYearPaid); }
      if (mode && mode.startsWith("key_uninsured_")) { const g = mode.replace("key_uninsured_", ""); return residents.filter(r => r.keyGroup === g && !r.thisYearPaid); }
      if (mode && mode.startsWith("key_")) return residents.filter(r => r.keyGroup === mode.replace("key_", ""));
      if (mode && mode.startsWith("loss_")) return residents.filter(r => r.lossReason === mode.replace("loss_", ""));
      if (filters[mode]) return all.filter(filters[mode]);
      return all;
    }

    function openDrawer(mode) {
      state.drawer = mode;
      const titleMap = {
        target_all: "目标覆盖对象名单",
        target_staff: "职工保目标对象名单",
        target_resident: "居民保目标对象名单",
        done_all: "已完成参保名单",
        staff_done: "已参保-职工保名单",
        resident_done: "已参保-居民保名单",
        staff_people_all: "职工参保总人数名单",
        staff_big_unit: "单位参保职工名单",
        staff_big_personal: "个人参保职工名单",
        staff_detail_onjob: "单位参保-在职职工名单",
        staff_detail_org_retired: "单位参保-单位退休人员名单",
        staff_detail_flex_1: "个人参保-灵活就业（一档）名单",
        staff_detail_flex_2: "个人参保-灵活就业（二档）名单",
        staff_detail_person_retired_1: "个人参保-个人退休（一档）名单",
        staff_detail_person_retired_2: "个人参保-个人退休（二档）名单",
        staff_unit_total: "全辖区单位总名单",
        staff_unit_insured: "参加职工保单位名单",
        staff_unit_uninsured: "未参加职工保单位名单",
        worker_done_resident: "已参保（居民保）名单",
        worker_stock_unpaid: "存量未参保（可动员）名单",
        worker_increment_potential: "可扩增量名单",
        worker_mobilizable: "可动员总名单",
        stock_hh_local_res_local: "存量未参保-户在人在名单",
        stock_hh_local_res_other: "存量未参保-户在人不在名单",
        stock_hh_other_res_local: "存量未参保-人在户不在名单",
        stock_hh_other_res_other: "存量未参保-人户均不在名单",
        inc_hh_local_res_local: "可扩增量-户在人在名单",
        inc_hh_local_res_other: "可扩增量-户在人不在名单",
        inc_hh_other_res_local: "可扩增量-人在户不在名单",
        hardship_pending_total: "重点资助对象（待动员）名单",
        hardship_type_低保对象: "重点资助对象-低保对象名单",
        hardship_type_残疾对象: "重点资助对象-残疾对象名单",
        hardship_type_特困对象: "重点资助对象-特困对象名单",
        resident_stock_done: "居民保-存量贡献名单",
        resident_increment_done: "居民保-增量贡献名单",
        gap_staff: "差距-职工保名单",
        gap_resident: "差距-居民保名单",
        mobilize_total: "居民保可动员总名单",
        mobilize_stock: "居民保可动员-存量名单",
        mobilize_increment: "居民保可动员-增量名单",
        need_mobilize: "需动员对象名单", progress: "参保进度对象名单", stock_total: "存量总数名单", stock_insured: "存量已参保（续保）名单", stock_uninsured: "存量未参保（可动员）名单", stock_retained: "存量巩固（续保）名单", stock_loss: "存量减员（已确认）名单", stock_unpaid: "存量未参保（可动员）人员名单",
        hh_local_total: "辖区户籍总人口名单", hh_local_insured: "辖区户籍-已参保名单", hh_local_uninsured: "辖区户籍-未参保名单",
        hh_local_insured_local: "已参保户籍-本区县参保名单", hh_local_insured_city_other: "已参保户籍-市内外区参保名单", hh_local_insured_outcity: "已参保户籍-市外参保名单",
        hh_local_uninsured_res_local: "未参保户籍-居住本辖区名单", hh_local_uninsured_res_district_other: "未参保户籍-居住区内其他辖区名单",
        hh_local_uninsured_res_city_other: "未参保户籍-居住市内外区名单", hh_local_uninsured_res_outcity: "未参保户籍-居住市外名单",
        hh_nonlocal_live_total: "非户籍居住总人口名单", hh_nonlocal_live_insured: "非户籍居住-已参保名单", hh_nonlocal_live_uninsured: "非户籍居住-未参保名单",
        increment_new: "新增参保名单", increment_potential: "可扩增量名单", risk_high: "高风险企业预警名单", risk_medium: "中风险企业预警名单",
        flow_resident: "转居民保名单", flow_pause: "申请停保名单", flow_transfer: "跨区转出名单"
      };
      if (mode && mode.startsWith("area|")) {
        const parts = mode.split("|");
        const unitName = parts[1];
        const baseMode = parts[2];
        const metricLabel = {
          target_all: "总任务",
          done_all: "总已完成",
          target_staff: "职工保任务",
          staff_done: "职工保已完成",
          target_resident: "居民保任务",
          resident_done: "居民保已完成"
        };
        titleMap[mode] = `${unitName} · ${metricLabel[baseMode] || "对象名单"}`;
      }
      if (mode && mode.startsWith("age_")) titleMap[mode] = `年龄组：${mode.replace("age_", "")}`;
      if (mode && mode.startsWith("key_insured_")) titleMap[mode] = `${mode.replace("key_insured_", "")}：已参保名单`;
      if (mode && mode.startsWith("key_uninsured_")) titleMap[mode] = `${mode.replace("key_uninsured_", "")}：未参保名单`;
      if (mode && mode.startsWith("key_")) titleMap[mode] = `重点对象：${mode.replace("key_", "")}`;
      if (mode && mode.startsWith("loss_")) titleMap[mode] = `减员原因：${mode.replace("loss_", "")}`;
      els.drawerTitle.textContent = titleMap[mode] || "明细名单";
      els.drawerType.innerHTML = `<option value="all">全部</option><option value="居民">居民</option><option value="企业">企业</option>`;
      const baseItems = getDrawerItems(mode);
      const typeSet = new Set(baseItems.map(x => x.type));
      const defaults = inferDefaultFilters(mode);
      els.drawerType.value = defaults.type || (typeSet.size === 1 ? [...typeSet][0] : "all");
      state.selectedTags = defaults.tags || [];
      els.searchName.value = "";
      els.searchSecond.value = "";
      els.searchAddress.value = "";
      updateQueryPlaceholders();
      renderConditionPanel();
      renderDrawerList();
      els.overlay.classList.add("show");
      els.drawer.classList.add("show");
    }

    function maskPhone(v) {
      if (!v) return "-";
      if (state.showFullPhone) return v;
      return `${v.slice(0,3)}****${v.slice(-4)}`;
    }

    function inferDefaultFilters(mode) {
      const out = { type: "all", tags: [] };
      if (mode.startsWith("risk_") || mode.startsWith("staff_unit_")) out.type = "企业";
      if (mode.startsWith("flow_") || mode.startsWith("age_") || mode.startsWith("key_") || mode.startsWith("hh_") || mode.startsWith("loss_") || mode.startsWith("worker_") || mode.startsWith("stock_") || mode.startsWith("inc_")) out.type = "居民";
      const map = {
        risk_high: ["高风险"],
        risk_medium: ["中风险"],
        flow_resident: ["转居民保"],
        flow_pause: ["申请停保"],
        flow_transfer: ["跨区转出"],
        stock_uninsured: ["存量未参保（可动员）"],
        stock_unpaid: ["存量未参保（可动员）"],
        worker_stock_unpaid: ["存量未参保（可动员）"],
        worker_increment_potential: ["今年未参保"],
        worker_done_resident: ["今年参保"]
      };
      if (mode.startsWith("age_")) out.tags = [mode.replace("age_", "")];
      if (mode.startsWith("loss_")) out.tags = [mode.replace("loss_", "")];
      if (mode.startsWith("key_insured_")) out.tags = [mode.replace("key_insured_", ""), "今年参保"];
      if (mode.startsWith("key_uninsured_")) out.tags = [mode.replace("key_uninsured_", ""), "今年未参保"];
      if (mode.startsWith("key_") && !mode.startsWith("key_insured_") && !mode.startsWith("key_uninsured_")) out.tags = [mode.replace("key_", "")];
      if (map[mode]) out.tags = [...map[mode]];
      return out;
    }

    function getTagGroups(items) {
      const groups = {};
      items.forEach(i => {
        getTags(i).forEach(t => {
          const g = t.group || "其他";
          if (!groups[g]) groups[g] = new Set();
          groups[g].add(t.text);
        });
      });
      return Object.fromEntries(Object.entries(groups).map(([k, set]) => [k, [...set].sort((a, b) => a.localeCompare(b, "zh-CN"))]));
    }

    function renderConditionPanel() {
      const baseItems = getDrawerItems(state.drawer);
      const t = els.drawerType.value || "all";
      const items = t === "all" ? baseItems : baseItems.filter(i => i.type === t);
      const groups = getTagGroups(items);
      const html = Object.keys(groups).length === 0
        ? '<div class="mini">暂无可选标签</div>'
        : Object.entries(groups).map(([g, tags]) => `
            <div class="cond-group">
              <div class="cond-group-title">${g}</div>
              <div class="cond-items">
                ${tags.map(tag => `<label class="cond-item"><input type="checkbox" data-tag="${tag}" ${state.selectedTags.includes(tag) ? "checked" : ""}/> ${tag}</label>`).join("")}
              </div>
            </div>`).join("");
      els.condGroups.innerHTML = html;
      els.condGroups.querySelectorAll("input[data-tag]").forEach(chk => {
        chk.onchange = () => {
          const tag = chk.dataset.tag;
          if (chk.checked) {
            if (!state.selectedTags.includes(tag)) state.selectedTags.push(tag);
          } else {
            state.selectedTags = state.selectedTags.filter(tg => tg !== tag);
          }
        };
      });
    }

    function updateQueryPlaceholders() {
      const t = els.drawerType.value || "all";
      if (t === "企业") {
        els.searchName.placeholder = "企业名称（模糊）";
        els.searchSecond.placeholder = "联系人（模糊）";
        els.searchAddress.placeholder = "企业地址（模糊）";
      } else if (t === "居民") {
        els.searchName.placeholder = "居民姓名（模糊）";
        els.searchSecond.placeholder = "联系电话（模糊）";
        els.searchAddress.placeholder = "地址（户籍/居住，模糊）";
      } else {
        els.searchName.placeholder = "姓名/企业名称（模糊）";
        els.searchSecond.placeholder = "联系电话/联系人（模糊）";
        els.searchAddress.placeholder = "地址（户籍/居住/企业地址，模糊）";
      }
    }

    function renderDrawerList() {
      let items = getDrawerItems(state.drawer);
      const t = els.drawerType.value || "all";
      if (t !== "all") items = items.filter(i => i.type === t);
      if (state.selectedTags.length) {
        items = items.filter(i => {
          const tags = getTags(i).map(x => x.text);
          return state.selectedTags.every(s => tags.includes(s));
        });
      }
      const kwName = (els.searchName.value || "").trim();
      const kwSecond = (els.searchSecond.value || "").trim();
      const kwAddr = (els.searchAddress.value || "").trim();
      if (kwName) items = items.filter(i => (i.name || "").includes(kwName));
      if (kwSecond) items = items.filter(i => i.type === "居民" ? (i.phone || "").includes(kwSecond) : ((i.contactPerson || "").includes(kwSecond)));
      if (kwAddr) items = items.filter(i => i.type === "居民"
        ? ((i.livingAddress || "").includes(kwAddr) || (i.hukouAddress || "").includes(kwAddr))
        : (i.regAddress || "").includes(kwAddr));
      items.sort((a, b) => (b.duration || 0) - (a.duration || 0));

      const summaryParts = [];
      const typeTxt = (els.drawerType.value || "all");
      if (typeTxt !== "all") summaryParts.push(typeTxt);
      if (state.selectedTags.length) summaryParts.push(state.selectedTags.join("、"));
      if (kwName) summaryParts.push(`名:${kwName}`);
      if (kwSecond) summaryParts.push(`联:${kwSecond}`);
      if (kwAddr) summaryParts.push(`址:${kwAddr}`);
      els.drawerResultText.textContent = `当前筛选结果：${items.length} 条${summaryParts.length ? " · " + summaryParts.join(" / ") : ""}`;
      els.drawerList.innerHTML = (items.map(x => {
        const tags = getTags(x).map(t => `<span class="tag ${t.level}">${t.text}</span>`).join("");
        const rightTop = x.type === "居民" ? unitText(x.age || 0, "岁") : `<span class="side-label">差异率</span>${unitText(x.gapRate || 0, "%")}`;
        const rightBottom = unitText(x.duration || 0, "月");
        const ext = x.type === "居民"
          ? `<div class="mini">联系电话：${maskPhone(x.phone)}</div><div class="mini">户籍地址：${x.hukouAddress || "-"}</div><div class="mini">居住地址：${x.livingAddress || "-"}</div>`
          : `<div class="mini">法人代表：${x.legalPerson || "-"}</div><div class="mini">联系人：${x.contactPerson || "-"} · ${maskPhone(x.phone)}</div><div class="mini">注册地址：${x.regAddress || "-"}</div>`;
        return `<div class="list-item"><div><div><b>${x.name}</b> <span class="mini">${x.type}</span></div><div class="mini">${x.place} · ${x.reason || ""}</div>${ext}<div class="tags">${tags}</div></div><div class="side-metric"><div class="row">${rightTop}</div><div class="row">${rightBottom}</div></div></div>`;
      }).join("") || '<div class="mini">暂无匹配对象</div>');
    }

    function getTags(x) {
      if (x.type === "居民") {
        return [
          { text: x.gender, level: "ok", group: "人员属性" },
          { text: x.ageGroup, level: "", group: "人员属性" },
          { text: x.household, level: "", group: "户籍属性" },
          { text: x.residenceDetail || x.residence, level: "", group: "居住属性" },
          ...(x.insuredPlace ? [{ text: x.insuredPlace, level: "ok", group: "参保去向" }] : []),
          ...(x.hardshipType ? [{ text: x.hardshipType, level: "warn", group: "重点属性" }] : []),
          ...(x.thisYearType === "职工保" ? [{ text: "职工保", level: "ok", group: "险种属性" }, { text: x.staffBigType || "职工参保", level: "", group: "险种属性" }, { text: x.staffDetailType || "细类未分", level: "", group: "险种属性" }] : []),
          { text: x.keyGroup !== "无" ? x.keyGroup : "普通", level: x.keyGroup !== "无" ? "warn" : "", group: "重点属性" },
          { text: x.lastYearPaid ? "去年参保" : "去年未参保", level: x.lastYearPaid ? "ok" : "", group: "参保状态" },
          { text: x.thisYearPaid ? "今年参保" : "今年未参保", level: x.thisYearPaid ? "ok" : "danger", group: "参保状态" },
          ...(x.reason ? [{ text: x.reason, level: x.thisYearPaid ? "ok" : "warn", group: "业务属性" }] : []),
          ...(x.pauseFlow ? [{ text: x.pauseFlow, level: "warn", group: "停保流向" }] : []),
          ...(x.lossReason ? [{ text: x.lossReason, level: "danger", group: "减员原因" }] : [])
        ];
      }
      return [
        { text: x.industry + "业", level: "", group: "企业属性" },
        { text: x.scale + "规模", level: "", group: "企业属性" },
        { text: x.staffInsured ? "已参加职工保单位" : "未参加职工保单位", level: x.staffInsured ? "ok" : "warn", group: "参保状态" },
        { text: x.risk + "风险", level: x.risk === "高" ? "danger" : (x.risk === "中" ? "warn" : "ok"), group: "风险等级" },
        { text: x.reason, level: x.risk === "高" ? "danger" : "warn", group: "风险原因" },
        { text: "欠费" + (x.duration || 0) + "月", level: "warn", group: "风险原因" }
      ];
    }

    function closeDrawer() {
      els.drawer.classList.remove("show");
      els.overlay.classList.remove("show");
      els.condPanel.classList.remove("show");
    }
    function syncRoleChips() {}
    function syncLevelChips() {}

    function render() {
      applyPermissionGuard();
      const node = currentNode();
      const p = currentProfile();
      els.userNameText.textContent = `当前用户：${p.userName}`;
      els.unitText.textContent = `所在单位：${p.unit}`;
      syncRoleChips();
      syncLevelChips();
      renderSelectors();
      els.leaderPanel.classList.toggle("active", state.role === "leader");
      els.workerPanel.classList.toggle("active", state.role === "worker");
      els.leaderSectionNav.style.display = state.role === "leader" ? "flex" : "none";
      if (state.role === "leader") {
        renderOverview(node);
        renderMap();
        renderStock(node);
        renderStructure(node);
        renderHousehold(node);
        renderKey(node);
        renderLoss(node);
        renderStaff(node);
        renderRisk(node);
      } else {
        renderWorker(node);
      }
    }

    document.getElementById("drawerClose").onclick = closeDrawer;
    document.getElementById("backLoginBtn").onclick = () => { location.href = "./login.html"; };
    els.overlay.onclick = closeDrawer;
    els.levelSelect.onchange = () => { state.level = els.levelSelect.value; render(); };
    els.yearSelect.onchange = () => { state.insuranceYear = Number(els.yearSelect.value); render(); };
    els.streetSelect.onchange = () => { state.street = els.streetSelect.value; state.village = getStreetObj().villages[0].name; render(); };
    els.villageSelect.onchange = () => { state.village = els.villageSelect.value; render(); };
    els.drawerType.onchange = () => { updateQueryPlaceholders(); renderConditionPanel(); renderDrawerList(); };
    els.conditionBtn.onclick = () => { renderConditionPanel(); els.condPanel.classList.add("show"); };
    els.condApply.onclick = () => { els.condPanel.classList.remove("show"); renderDrawerList(); };
    els.condReset.onclick = () => { state.selectedTags = []; renderConditionPanel(); renderDrawerList(); };
    els.searchName.oninput = renderDrawerList;
    els.searchSecond.oninput = renderDrawerList;
    els.searchAddress.oninput = renderDrawerList;
    els.phoneToggle.onchange = () => { state.showFullPhone = !!els.phoneToggle.checked; renderDrawerList(); };
    document.querySelectorAll("#leaderSectionNav .nav-chip").forEach(btn => {
      btn.onclick = () => {
        const target = document.getElementById(btn.dataset.target);
        if (!target) return;
        const navH = els.leaderSectionNav ? els.leaderSectionNav.getBoundingClientRect().height : 0;
        const top = target.getBoundingClientRect().top + window.pageYOffset - navH - 12;
        window.scrollTo({ top, behavior: "smooth" });
      };
    });
    document.getElementById("navTopBtn").onclick = () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    const q = new URLSearchParams(location.search);
    const id = q.get("identity");
    if (!id || !identityProfiles[id]) {
      location.href = "./login.html";
    } else {
      state.identity = id;
    }
    render();
  </script>
</body>
</html>
